<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>R√°dio Caverna do Rock 69</title>
<style>
/* Reset e Base para Smart TV */
body {
  background: #111;
  color: #fff;
  font-family: 'Roboto', Arial, sans-serif; /* Fonte mais limpa */
  margin: 0;
  font-size: 20px; /* Aumento da fonte base para legibilidade em TV */
  line-height: 1.4;
}

/* Cabe√ßalho */
.header {
  background: #000;
  border-bottom: 4px solid #e94560; /* Borda mais grossa */
  padding: 20px;
  text-align: center;
}
.logo {
  color: #e94560;
  font-size: 36px; /* Logo maior */
  font-weight: bold;
}
.subtitle {
  font-size: 18px;
  color: #ccc;
}

/* Layout Principal (Duas Colunas para TV) */
.main-layout {
  display: flex;
  flex-direction: column; /* Padr√£o para mobile/telas pequenas */
  padding: 20px;
  max-width: 1400px;
  margin: 0 auto;
}

@media (min-width: 1024px) {
  .main-layout {
    flex-direction: row; /* Duas colunas em telas grandes (TV) */
    align-items: flex-start;
  }
  .player-section {
    flex: 1;
    padding-right: 30px;
    position: sticky; /* Player fixo na lateral */
    top: 20px;
  }
  .playlist-section {
    flex: 2;
  }
}

/* Player e Controles */
.player-section {
  text-align: center;
  margin-bottom: 30px;
}

.track-info {
  margin-top: 20px;
  min-height: 100px; /* Espa√ßo reservado para evitar pulos */
}

.track-title {
  color: #e94560;
  font-size: 28px; /* T√≠tulo maior */
  font-weight: bold;
  margin-bottom: 5px;
}
.track-artist {
  font-size: 20px;
  color: #ccc;
}

.controls {
  margin-top: 20px;
}

button {
  background: #333;
  color: #fff;
  border: none;
  border-radius: 10px; /* Bordas mais arredondadas */
  margin: 10px;
  padding: 15px 25px; /* Bot√µes maiores */
  font-size: 24px; /* √çcones maiores */
  cursor: pointer;
  transition: background 0.2s, box-shadow 0.2s;
}
button:hover {
  background: #444;
}
button.active {
  background: #e94560;
}

/* Foco para Smart TV (Muito Importante) */
button:focus, .track:focus {
  outline: none;
  box-shadow: 0 0 0 5px #fff, 0 0 0 10px #e94560; /* Destaque duplo e forte */
  background: #444;
}

/* Busca */
#search {
  width: 100%;
  padding: 15px; /* Campo de busca maior */
  border: none;
  border-radius: 10px;
  margin-bottom: 20px;
  font-size: 20px;
  background: #222;
  color: #fff;
}

/* Playlist */
.playlist-section {
  text-align: left;
}

.playlist {
  margin-top: 15px;
  max-height: 70vh; /* Altura m√°xima relativa para TV */
  overflow-y: auto;
  padding-right: 10px; /* Espa√ßo para a barra de rolagem */
}

.artist {
  font-size: 24px; /* T√≠tulo de artista maior */
  color: #e94560;
  margin-top: 25px;
  border-bottom: 2px solid #333;
  padding-bottom: 5px;
}
.album {
  font-size: 20px;
  margin-left: 10px;
  color: #ddd;
  margin-top: 10px;
}
.track {
  padding: 10px 15px; /* Item da faixa maior */
  cursor: pointer;
  margin-left: 20px;
  border-radius: 5px;
  transition: background 0.2s;
  tabindex: 0; /* Torna o elemento foc√°vel */
}
.track:hover {
  background: #222;
}
.track.active {
  background: rgba(233,69,96,0.5); /* Destaque mais forte */
  font-weight: bold;
}

/* Status */
#status {
  margin-top: 15px;
  color: #aaa;
  font-size: 18px;
}
</style>
</head>
<body>
<div class="header">
  <div class="logo">üé∏ R√°dio Caverna do Rock 69</div>
  <div class="subtitle">A melhor sele√ß√£o de rock</div>
</div>

<div class="main-layout">
  <div class="player-section">
    <!-- O player nativo foi removido para usar apenas os controles customizados -->
    <audio id="player" style="display:none;"></audio>
    
    <div class="track-info">
      <div class="track-title" id="trackTitle">Carregando...</div>
      <div class="track-artist" id="trackArtist">-</div>
    </div>

    <div class="controls">
      <button id="shuffleBtn" onclick="toggleShuffle()" title="Modo Aleat√≥rio">üîÄ</button>
      <button onclick="prevTrack()" title="Faixa Anterior">‚èÆ</button>
      <button id="playPauseBtn" onclick="togglePlay()" title="Tocar/Pausar">‚ñ∂</button>
      <button onclick="nextTrack()" title="Pr√≥xima Faixa">‚è≠</button>
    </div>
    <div id="status">Carregando playlist...</div>
  </div>

  <div class="playlist-section">
    <input type="text" id="search" placeholder="üîç Buscar artista, √°lbum ou m√∫sica..." onkeyup="filterPlaylist()">
    <div class="playlist" id="playlist"></div>
  </div>
</div>

<script>
var m3uUrl = "https://raw.githubusercontent.com/cavernadorock69/cavernadorock69.github.io/refs/heads/main/caverna_mp3.m3u";

var audio = document.getElementById("player");
var titleEl = document.getElementById("trackTitle");
var artistEl = document.getElementById("trackArtist");
var playlistEl = document.getElementById("playlist");
var statusEl = document.getElementById("status");
var shuffleBtn = document.getElementById("shuffleBtn");
var playPauseBtn = document.getElementById("playPauseBtn");
var searchInput = document.getElementById("search");

var tracks = [];
var organized = {}; // { artista: { album: [faixas] } }
var flatList = []; // lista linear de todas as faixas (para tocar)
var current = -1;
var isShuffle = false;

function loadPlaylist() {
  var xhr = new XMLHttpRequest();
  xhr.open("GET", m3uUrl, true);
  xhr.onreadystatechange = function() {
    if (xhr.readyState == 4 && xhr.status == 200) {
      parseM3U(xhr.responseText);
      organizeTracks();
      renderPlaylist();
      if (flatList.length > 0) playTrack(0);
    }
  };
  xhr.send();
}

function parseM3U(text) {
  var lines = text.split(/\r?\n/);
  var currentArt = "Desconhecido";
  var currentAlb = "Desconhecido";
  var currentTitle = "";
  tracks = [];
  for (var i=0;i<lines.length;i++) {
    var line = lines[i].trim();
    if (!line) continue;
    if (line.indexOf("#EXTART:") == 0) currentArt = line.substring(8).trim();
    else if (line.indexOf("#EXTALB:") == 0) currentAlb = line.substring(8).trim();
    else if (line.indexOf("#EXTINF:") == 0) {
      var parts = line.split(",");
      currentTitle = parts.length > 1 ? parts[1].trim() : "Faixa desconhecida";
    }
    else if (line.indexOf("http") == 0) {
      tracks.push({ artist: currentArt, album: currentAlb, title: currentTitle, url: line });
    }
  }
}

function organizeTracks() {
  organized = {};
  flatList = [];
  for (var i=0;i<tracks.length;i++) {
    var t = tracks[i];
    if (!organized[t.artist]) organized[t.artist] = {};
    if (!organized[t.artist][t.album]) organized[t.artist][t.album] = [];
    organized[t.artist][t.album].push(t);
    flatList.push(t);
  }
}

function renderPlaylist(filter) {
  playlistEl.innerHTML = "";
  var trackIndex = 0; // Novo √≠ndice para mapear com flatList
  
  for (var art in organized) {
    var artistDiv = document.createElement("div");
    artistDiv.className = "artist";
    artistDiv.innerHTML = art;
    playlistEl.appendChild(artistDiv);

    var albums = organized[art];
    for (var alb in albums) {
      var albDiv = document.createElement("div");
      albDiv.className = "album";
      albDiv.innerHTML = alb;
      playlistEl.appendChild(albDiv);

      var faixas = albums[alb];
      for (var i=0;i<faixas.length;i++) {
        var f = faixas[i];
        
        // Encontra o √≠ndice na flatList para esta faixa
        var flatIndex = flatList.findIndex(item => item.url === f.url);

        if (filter && !matchFilter(f, filter)) {
            // Se estiver filtrando e n√£o houver correspond√™ncia, apenas pula
            continue;
        }
        
        var tDiv = document.createElement("div");
        tDiv.className = "track";
        tDiv.innerHTML = f.title;
        tDiv.setAttribute("data-index", flatIndex); // Armazena o √≠ndice da flatList
        tDiv.setAttribute("tabindex", "0"); // Torna foc√°vel para navega√ß√£o com controle remoto
        
        tDiv.onclick = function() {
          var idx = parseInt(this.getAttribute("data-index"));
          playTrack(idx);
        };
        
        playlistEl.appendChild(tDiv);
        trackIndex++;
      }
    }
  }
  statusEl.innerHTML = flatList.length + " faixas carregadas.";
  updateActive(); // Atualiza o destaque ap√≥s renderizar
}

function matchFilter(f, text) {
  var s = text.toLowerCase();
  return f.title.toLowerCase().indexOf(s) >= 0 ||
         f.artist.toLowerCase().indexOf(s) >= 0 ||
         f.album.toLowerCase().indexOf(s) >= 0;
}

function filterPlaylist() {
  var text = searchInput.value.trim();
  renderPlaylist(text);
}

function playTrack(i) {
  if (i<0 || i>=flatList.length) return;
  current = i;
  var t = flatList[i];
  audio.src = t.url;
  audio.play();
  titleEl.innerHTML = t.title;
  artistEl.innerHTML = t.artist + " ‚Äî " + t.album;
  updateActive();
  updatePlayPauseButton();
}

function updateActive() {
  var all = playlistEl.querySelectorAll(".track");
  all.forEach(function(el) {
    var index = parseInt(el.getAttribute("data-index"));
    if (index === current) {
      el.classList.add("active");
      // Rola para o elemento ativo (√∫til para TV)
      el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    } else {
      el.classList.remove("active");
    }
  });
}

function updatePlayPauseButton() {
    playPauseBtn.innerHTML = audio.paused ? "‚ñ∂" : "‚è∏";
}

function togglePlay() {
  if (audio.paused) {
    audio.play();
  } else {
    audio.pause();
  }
  updatePlayPauseButton();
}

function nextTrack() {
  if (isShuffle) {
    var newIndex = current;
    while (newIndex == current && flatList.length > 1)
      newIndex = Math.floor(Math.random()*flatList.length);
    playTrack(newIndex);
  } else {
    current++;
    if (current >= flatList.length) current = 0;
    playTrack(current);
  }
}

function prevTrack() {
  if (isShuffle) {
    var newIndex = current;
    while (newIndex == current && flatList.length > 1)
      newIndex = Math.floor(Math.random()*flatList.length);
    playTrack(newIndex);
  } else {
    current--;
    if (current < 0) current = flatList.length-1;
    playTrack(current);
  }
}

function toggleShuffle() {
  isShuffle = !isShuffle;
  shuffleBtn.classList.toggle("active", isShuffle);
  statusEl.innerHTML = isShuffle ? "Modo aleat√≥rio ligado." : "Modo normal.";
}

// Event Listeners
audio.addEventListener("ended", function() { nextTrack(); });
audio.addEventListener("play", updatePlayPauseButton);
audio.addEventListener("pause", updatePlayPauseButton);

// Inicializa√ß√£o
window.onload = function() { loadPlaylist(); };
</script>
</body>
</html>
