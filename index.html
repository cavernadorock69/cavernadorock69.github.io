<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Caverna do Rock 69</title>
<style>
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body { 
  margin: 0; 
  padding: 20px;
  font-family: "Arial", "MS Sans Serif", sans-serif; 
  background: #000000; 
  color: #ffffff; 
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  position: relative;
  overflow: auto;
}

.album-background {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  opacity: 0.15;
  z-index: -1;
}

.winamp-container {
  width: min(1000px, 95vw);
  max-height: 95vh;
  display: flex;
  flex-direction: column;
  gap: 10px;
  z-index: 1;
}

.winamp-window {
  width: 100%;
  background: #000000;
  border: 2px solid #ffffff;
  box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
}

.winamp-titlebar {
  background: #000000;
  color: #ffcc00;
  padding: 8px 12px;
  font-size: clamp(16px, 3vw, 22px);
  font-weight: bold;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 2px solid #444444;
  text-transform: uppercase;
}

.titlebar-text { 
  flex-grow: 1; 
  text-align: center; 
  font-weight: bold; 
}

.titlebar-buttons { 
  display: flex; 
}

.titlebar-button {
  width: clamp(20px, 4vw, 26px);
  height: clamp(18px, 4vw, 22px);
  margin-left: 4px;
  font-size: clamp(12px, 2.5vw, 16px);
  text-align: center;
  line-height: clamp(18px, 4vw, 22px);
  background: #404040;
  color: #ffffff;
  border: 1px solid #808080;
  cursor: pointer;
}

.winamp-content { 
  padding: 12px; 
  background: #000000; 
}

.header { 
  padding: 10px;
  background: #000000; 
  display: flex; 
  justify-content: space-between; 
  align-items: center;
  border: 1px solid #444444;
  margin-bottom: 10px;
  flex-wrap: wrap;
  gap: 8px;
}

.logo-container {
  display: flex;
  align-items: center;
  gap: 10px;
}

.logo {
  height: 40px;
  width: auto;
}

.header h1 { 
  font-size: clamp(18px, 4vw, 24px); 
  font-weight: bold; 
  margin: 0; 
  color: #ffcc00; 
  text-transform: uppercase; 
}

.search-box { 
  flex-grow: 1; 
  min-width: 120px;
}

.search-box input { 
  padding: 6px 10px;
  border: 1px solid #444444; 
  background: #000000; 
  color: #ffffff; 
  width: 100%;
  font-size: clamp(12px, 2.5vw, 16px);
}

.main { 
  display: flex; 
  flex-direction: row;
  gap: 10px; 
  align-items: flex-start;
}

.playlist-container {
  flex: 1;
  display: flex;
  flex-direction: column;
  border: 1px solid #444444;
}

.sidebar { 
  height: 45vh;
  background: #000000; 
  padding: 8px;
  overflow-y: auto; 
  font-size: clamp(12px, 2.5vw, 16px);
  color: #ffffff; 
}

.player { 
  flex: 1;
  min-width: 280px;
  background: #000000; 
  padding: 12px;
  display: flex; 
  flex-direction: column; 
  align-items: center; 
  border: 1px solid #444444; 
  position: relative; 
}

.artist-title { 
  font-weight: bold; 
  margin-top: 12px;
  font-size: clamp(14px, 3vw, 18px);
  color: #ffcc00; 
  background: #222222; 
  padding: 4px 8px;
}

.album-title { 
  margin-left: 16px;
  font-style: italic; 
  color: #00ccff; 
  margin-top: 8px;
  font-size: clamp(12px, 2.5vw, 16px);
}

.album-artist-name {
  color: #cccccc;
  font-style: normal;
  font-size: 0.9em;
}

.track-item { 
  padding: 5px 8px 5px 30px;
  cursor: pointer; 
  border-bottom: 1px solid #333333; 
  font-size: clamp(12px, 2.5vw, 16px);
  color: #ffffff; 
}

.track-item:hover { 
  background: #333333; 
  color: #ffcc00; 
}

.track-item.playing { 
  background: #000066; 
  color: #ffcc00;
  font-weight: bold; 
}

.cover-art { 
  max-width: min(120px, 25vw);
  display: none; 
  margin-bottom: 12px;
  border: 1px solid #444444; 
}

.player-controls { 
  display: flex; 
  margin-bottom: 12px;
  align-items: center; 
  flex-wrap: wrap;
  justify-content: center;
  gap: 5px;
  width: 100%;
}

.winamp-button {
  width: clamp(36px, 8vw, 44px);
  height: clamp(36px, 8vw, 44px);
  background: #333333;
  color: #ffffff;
  border: 1px solid #808080;
  cursor: pointer;
  font-size: clamp(14px, 3vw, 18px);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0;
}

.winamp-button:hover { 
  background: #444444; 
}

.winamp-button:active { 
  background: #222222; 
  border-color: #666666; 
}

.winamp-button.toggled { 
  background: #000066; 
  color: #ffcc00; 
}

#volumeControl { 
  width: min(120px, 25vw);
  height: 20px;
  -webkit-appearance: none; 
  background: #333333; 
  border: 1px solid #808080; 
  margin-left: 8px;
}

#volumeControl::-webkit-slider-thumb { 
  -webkit-appearance: none; 
  width: 16px;
  height: 24px;
  background: #ffcc00; 
  border: 1px solid #808080; 
}

.progress-container {
  width: 100%;
  margin: 8px 0;
  display: flex;
  align-items: center;
  gap: 10px;
}

#progressBar {
  flex-grow: 1;
  height: 15px;
  -webkit-appearance: none;
  background: #333333;
  border: 1px solid #808080;
  cursor: pointer;
}

#progressBar::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 12px;
  height: 20px;
  background: #ffcc00;
  border: 1px solid #808080;
}

#progressBar::-webkit-slider-runnable-track {
  height: 15px;
  background: #222222;
  border: none;
}

.time-display {
  font-size: clamp(12px, 2.5vw, 14px);
  color: #ffcc00;
  min-width: 100px;
  text-align: center;
}

#track-info { 
  margin-top: 10px;
  font-weight: bold; 
  text-align: center; 
  font-size: clamp(12px, 2.5vw, 16px);
  background: #222222; 
  padding: 5px 10px;
  border: 1px solid #444444; 
  width: 100%; 
  color: #ffcc00; 
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

#startIcon { 
  position: absolute; 
  top: 50%; 
  left: 50%; 
  transform: translate(-50%, -50%); 
  font-size: clamp(3rem, 10vw, 5rem);
  cursor: pointer; 
  color: #ffcc00; 
  z-index: 1000; 
  text-shadow: 2px 2px 0 #000; 
}

.format-filters { 
  display: flex; 
  padding: 8px;
  background: #111111;
  border-bottom: 1px solid #444444;
  flex-wrap: wrap;
  gap: 5px;
}

.format-button { 
  padding: 4px 10px;
  background: #333333; 
  color: #ffffff; 
  border: 1px solid #808080; 
  font-size: clamp(11px, 2vw, 14px);
  cursor: pointer; 
}

.format-button.active { 
  background: #000066; 
  color: #ffcc00; 
}

#audio-player { 
  display: none; 
}

.sidebar::-webkit-scrollbar { 
  width: 12px; 
}

.sidebar::-webkit-scrollbar-track { 
  background: #222222; 
  border-left: 1px solid #444444; 
}

.sidebar::-webkit-scrollbar-thumb { 
  background: #444444; 
  border: 1px solid #222222; 
}

.sidebar::-webkit-scrollbar-thumb:hover { 
  background: #555555; 
}

@media (max-width: 768px) {
  .main {
    flex-direction: column;
  }
  
  .playlist-container, .player {
    width: 100%;
  }
  
  .sidebar {
    height: 35vh;
  }
  
  .header {
    flex-direction: column;
    align-items: stretch;
  }
  
  .logo-container {
    justify-content: center;
    margin-bottom: 8px;
  }
  
  .search-box {
    min-width: 100%;
  }
  
  .progress-container {
    flex-direction: column;
    gap: 5px;
  }
  
  .time-display {
    width: 100%;
    text-align: center;
  }
}
</style>
</head>
<body>

<div class="album-background"></div>

<div class="winamp-container">
  <div class="winamp-window">
    <div class="winamp-titlebar">
      <div class="titlebar-buttons">
        <div class="titlebar-button">‚Äî</div>
        <div class="titlebar-button">‚ñ°</div>
        <div class="titlebar-button">√ó</div>
      </div>
      <div class="titlebar-text">Caverna do Rock 69</div>
      <div class="titlebar-buttons">
        <div class="titlebar-button">‚Äî</div>
      </div>
    </div>
    <div class="winamp-content">
      <div class="header">
        <div class="logo-container">
          <img src="https://github.com/cavernadorock69/cavernadorock69.github.io/blob/main/logo_caverna_do_rock_69.png?raw=true" alt="Caverna do Rock" class="logo">
          <h1>Caverna do Rock</h1>
        </div>
        <div class="search-box">
          <input type="text" id="searchInput" placeholder="Buscar por m√∫sica, artista ou √°lbum...">
        </div>
      </div>
      
      <div class="main">
        <div class="playlist-container">
          <div class="format-filters" id="formatFilters"></div>
          <div class="sidebar" id="sidebar">
            <div id="results">Carregando...</div>
          </div>
        </div>

        <div class="player">
          <div id="startIcon">‚ñ∂</div>
          <img id="cover-art" class="cover-art">
          <div class="player-controls">
            <button class="winamp-button" id="prevBtn">‚èÆ</button>
            <button class="winamp-button" id="playPauseBtn">‚ñ∂</button>
            <button class="winamp-button" id="stopBtn">‚èπ</button>
            <button class="winamp-button" id="nextBtn">‚è≠</button>
            <button class="winamp-button" id="shuffleBtn">üîÄ</button>
            <button class="winamp-button" id="repeatBtn">üîÅ</button>
            <input type="range" id="volumeControl" min="0" max="1" step="0.01" value="0.5">
          </div>
          <div class="progress-container">
            <input type="range" id="progressBar" min="0" max="100" value="0" step="0.1">
            <div class="time-display" id="timeDisplay">00:00 / 00:00</div>
          </div>
          <audio id="audio-player"></audio>
          <div id="track-info"></div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
// Configura√ß√µes
var ALLOWED_EXT=['mp3','wav','ogg','flac','mp4'];
var IMAGE_EXT=['jpg','jpeg','png','gif'];
var tracks=[], allTracks=[], currentTrack=0, currentFormat='mp3';
var shuffle=false, repeat=false;
var isSeeking = false;

var audioPlayer=document.getElementById('audio-player' );
var resultsContainer=document.getElementById('results');
var trackInfo=document.getElementById('track-info');
var coverArt=document.getElementById('cover-art');
var playPauseBtn=document.getElementById('playPauseBtn');
var volumeControl=document.getElementById('volumeControl');
var formatFilters=document.getElementById('formatFilters');
var searchInput=document.getElementById('searchInput');
var startIcon=document.getElementById('startIcon');
var prevBtn=document.getElementById('prevBtn');
var stopBtn=document.getElementById('stopBtn');
var nextBtn=document.getElementById('nextBtn');
var shuffleBtn=document.getElementById('shuffleBtn');
var repeatBtn=document.getElementById('repeatBtn');
var progressBar=document.getElementById('progressBar');
var timeDisplay=document.getElementById('timeDisplay');

// ############################## LINKS ############################## //
var minhaColecao = [
  "https://archive.org/details/master-of-puppets_202509",
  "https://archive.org/details/1980-Back-in-Black"
];

var outrosUsuarios = [
  "https://archive.org/details/14.-for-those-about-to-rock-we-sa",
  "https://archive.org/details/100-hits-rock-jukebox-2016"
];

var albumLinks = minhaColecao.concat(outrosUsuarios );

// Estrutura de dados
var albumsData = {}; // artista ‚Üí [{title, year, cover, tracks}]

// Fun√ß√£o para formatar o tempo (segundos para MM:SS)
function formatTime(seconds) {
  if (isNaN(seconds)) return "00:00";
  const mins = Math.floor(seconds / 60);
  const secs = Math.floor(seconds % 60);
  return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
}

// Atualizar a barra de progresso e o tempo
function updateProgress() {
  if (!isSeeking && audioPlayer.duration) {
    const percentage = (audioPlayer.currentTime / audioPlayer.duration) * 100;
    progressBar.value = percentage;
    timeDisplay.textContent = `${formatTime(audioPlayer.currentTime)} / ${formatTime(audioPlayer.duration)}`;
  }
}

// Fun√ß√£o principal para carregar √°lbuns
function carregarAlbuns(){
  resultsContainer.innerHTML='Carregando...';
  allTracks=[];
  if(albumLinks.length===0){
    resultsContainer.innerHTML='Nenhum √°lbum adicionado.';
    return;
  }
  var remaining=albumLinks.length;
  albumLinks.forEach(link=>{
    var id=link.split('/').pop();
    var xhr=new XMLHttpRequest();
    xhr.open('GET','https://archive.org/metadata/'+id,true );
    xhr.onreadystatechange=function(){
      if(xhr.readyState===4 && xhr.status===200){
        var data=JSON.parse(xhr.responseText);

        var artist = (data.metadata && data.metadata.creator) ? data.metadata.creator : 'Desconhecido';
        var albumTitle = (data.metadata && data.metadata.title) ? data.metadata.title : id;
        var year = 9999;
        if(data.metadata){
          if(data.metadata.date) year = parseInt(data.metadata.date) || 9999;
          else if(data.metadata.year) year = parseInt(data.metadata.year) || 9999;
        }

        var trackList=[];
        var coverUrl=null;

        data.files.forEach(f=>{
          var ext=f.name.split('.').pop().toLowerCase();
          if(IMAGE_EXT.includes(ext) && /cover|folder|front/i.test(f.name)){
            coverUrl='https://archive.org/download/'+id+'/'+encodeURIComponent(f.name );
          }
          if(ALLOWED_EXT.includes(ext)){
            var track={
              title:f.name,
              url:'https://archive.org/download/'+id+'/'+encodeURIComponent(f.name ),
              type:(ext==='mp4'?'video':'audio'),
              artist:artist,
              album:albumTitle,
              format:ext
            };
            trackList.push(track);
            allTracks.push(track);
          }
        });

        if(!albumsData[artist]) albumsData[artist]=[];
        albumsData[artist].push({title:albumTitle, year:year, cover:coverUrl, tracks:trackList});

        remaining--;
        if(remaining===0){
          criarFiltros();
          renderAll();
        }
      }
    };
    xhr.send();
  });
}

// Cria√ß√£o de filtros por formato
function criarFiltros(){
  var formats={};
  allTracks.forEach(t=>formats[t.format]=true);
  formatFilters.innerHTML='';
  for(var fmt in formats){
    (function(fmt){
      var btn=document.createElement('button');
      btn.textContent=fmt.toUpperCase();
      btn.className='format-button' + (fmt===currentFormat?' active':'');
      btn.onclick=function(){
        currentFormat=fmt;
        Array.from(formatFilters.getElementsByTagName('button')).forEach(b=>b.className='format-button');
        this.className='format-button active';
        renderAll();
      };
      formatFilters.appendChild(btn);
    })(fmt);
  }
}

// Renderiza lista de √°lbuns e m√∫sicas
function renderAll(){
  resultsContainer.innerHTML='';
  tracks=[];
  
  const renderSection = (linksArray, title) => {
    if(linksArray.length > 0) {
      var headerDiv = document.createElement('div');
      headerDiv.className = 'artist-title';
      headerDiv.textContent = title;
      resultsContainer.appendChild(headerDiv);
      albumLinksRender(linksArray);
    }
  };

  renderSection(minhaColecao, 'Minha Cole√ß√£o');
  renderSection(outrosUsuarios, 'Outros Usu√°rios');
  
  applySearchFilter();
}

// ########## FUN√á√ÉO DE RENDERIZA√á√ÉO COM ORDENA√á√ÉO ##########
function albumLinksRender(linksArray){
  // Pega todos os artistas que t√™m √°lbuns na lista de links fornecida
  const artistsInScope = Object.keys(albumsData).filter(artist => 
    albumsData[artist].some(album => 
      linksArray.some(link => 
        album.tracks.some(t => t.url.includes(link.split('/').pop()))
      )
    )
  );

  // 1. Ordena os artistas alfabeticamente
  artistsInScope.sort((a, b) => a.localeCompare(b));

  artistsInScope.forEach(artist => {
    // Pega os √°lbuns do artista que est√£o no escopo atual
    const artistAlbums = albumsData[artist]
      .filter(album => linksArray.some(link => album.tracks.some(t => t.url.includes(link.split('/').pop()))));

    // 2. Ordena os √°lbuns por ano (e depois por t√≠tulo, como desempate)
    artistAlbums.sort((a, b) => {
      if (a.year !== b.year) {
        return a.year - b.year;
      }
      return a.title.localeCompare(b.title);
    });

    artistAlbums.forEach(album => {
      const albumContainer = document.createElement('div');
      albumContainer.className = 'album-container';
      albumContainer.dataset.artist = artist.toLowerCase();
      albumContainer.dataset.album = album.title.toLowerCase();
      
      const albDiv = document.createElement('div');
      albDiv.className = 'album-title';
      albDiv.innerHTML = `${album.title} ${album.year !== 9999 ? `(${album.year})` : ''} <span class="album-artist-name">- ${artist}</span>`;
      albumContainer.appendChild(albDiv);

      album.tracks.forEach(track => {
        if(track.format !== currentFormat) return;
        
        track.index = tracks.length;
        track.albumCover = album.cover;
        
        const trackDiv = document.createElement('div');
        trackDiv.className = 'track-item';
        trackDiv.textContent = track.title;
        trackDiv.dataset.title = track.title.toLowerCase();
        trackDiv.onclick = function(){ shuffle = false; playTrack(track.index); };
        
        track.element = trackDiv;
        tracks.push(track);
        albumContainer.appendChild(trackDiv);
      });
      
      if (albumContainer.getElementsByClassName('track-item').length > 0) {
        resultsContainer.appendChild(albumContainer);
      }
    });
  });
}

function applySearchFilter() {
  const term = searchInput.value.toLowerCase();
  const allAlbumContainers = resultsContainer.getElementsByClassName('album-container');

  for (let container of allAlbumContainers) {
    const artistMatch = container.dataset.artist.includes(term);
    const albumMatch = container.dataset.album.includes(term);
    
    if (artistMatch || albumMatch) {
      const tracksInContainer = container.getElementsByClassName('track-item');
      for (let trackEl of tracksInContainer) {
        trackEl.style.display = 'block';
      }
      container.style.display = 'block';
      continue;
    }

    let hasVisibleTrack = false;
    const tracksInContainer = container.getElementsByClassName('track-item');
    for (let trackEl of tracksInContainer) {
      const titleMatch = trackEl.dataset.title.includes(term);
      if (titleMatch) {
        trackEl.style.display = 'block';
        hasVisibleTrack = true;
      } else {
        trackEl.style.display = 'none';
      }
    }
    
    container.style.display = hasVisibleTrack ? 'block' : 'none';
  }
}

// Fun√ß√µes de reprodu√ß√£o
function playTrack(index){
  var track=tracks[index]; if(!track) return;
  currentTrack=index;
  tracks.forEach(t => {
    if(t.element) t.element.classList.remove('playing');
  });
  track.element.classList.add('playing');
  trackInfo.textContent=track.artist+' - '+track.title;
  playPauseBtn.textContent='‚è∏';
  audioPlayer.pause(); audioPlayer.src='';
  audioPlayer.src=track.url;
  
  progressBar.value = 0;
  timeDisplay.textContent = "00:00 / 00:00";
  
  if(track.albumCover){
    coverArt.src=track.albumCover;
    coverArt.style.display='block';
    document.querySelector('.album-background').style.backgroundImage = `url('${track.albumCover}')`;
  } else { 
    coverArt.style.display='none'; 
  }
  
  audioPlayer.play().catch((e)=>{
    console.error("Erro ao reproduzir √°udio:", e);
    trackInfo.textContent = "Erro ao reproduzir: " + track.title;
  });
}

function playRandomTrack(){ if(tracks.length===0) return; var r=Math.floor(Math.random()*tracks.length); playTrack(r); }
function stopTrack(){ audioPlayer.pause(); audioPlayer.currentTime=0; playPauseBtn.textContent='‚ñ∂'; progressBar.value = 0; timeDisplay.textContent = "00:00 / 00:00"; }
function togglePlayPause(){ 
  if (audioPlayer.paused) {
    if (audioPlayer.src) {
      audioPlayer.play();
      playPauseBtn.textContent='‚è∏';
    } else if (tracks.length > 0) {
      playRandomTrack();
    }
  } else {
    audioPlayer.pause();
    playPauseBtn.textContent='‚ñ∂';
  }
}

function toggleShuffle(){ shuffle=!shuffle; shuffleBtn.classList.toggle('toggled', shuffle); }
function toggleRepeat(){ repeat=!repeat; repeatBtn.classList.toggle('toggled', repeat); }

// Event listeners
volumeControl.addEventListener('input',()=>audioPlayer.volume=volumeControl.value);
audioPlayer.addEventListener('loadedmetadata', () => timeDisplay.textContent = `00:00 / ${formatTime(audioPlayer.duration)}`);
audioPlayer.addEventListener('timeupdate', updateProgress);
audioPlayer.addEventListener('ended',()=>{ 
  if(repeat){playTrack(currentTrack);} 
  else{ shuffle?playRandomTrack():playTrack((currentTrack+1)%tracks.length); } 
});

progressBar.addEventListener('input', () => isSeeking = true);
progressBar.addEventListener('change', () => {
  if (audioPlayer.duration) {
    audioPlayer.currentTime = (progressBar.value / 100) * audioPlayer.duration;
  }
  isSeeking = false;
});

searchInput.addEventListener('input', applySearchFilter);

startIcon.addEventListener('click',()=>{ startIcon.style.display='none'; if (tracks.length > 0) playRandomTrack(); });
prevBtn.addEventListener('click',()=>{ if(tracks.length > 0) { currentTrack=(currentTrack-1+tracks.length)%tracks.length; playTrack(currentTrack); }});
nextBtn.addEventListener('click',()=>{ if(tracks.length > 0) { currentTrack=(currentTrack+1)%tracks.length; playTrack(currentTrack); }});
playPauseBtn.addEventListener('click',togglePlayPause);
stopBtn.addEventListener('click',stopTrack);
shuffleBtn.addEventListener('click',toggleShuffle);
repeatBtn.addEventListener('click',toggleRepeat);

// Iniciar carregamento
carregarAlbuns();
</script>
</body>
</html>
