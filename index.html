<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>🎵 Gerenciador de Listas M3U - Caverna do Rock</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #121212;
    color: #eee;
    margin: 0;
    padding: 20px;
  }
  h1 {
    text-align: center;
    margin-bottom: 25px;
    color: #fff;
  }
  .categoria {
    background: #1e1e1e;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 30px;
    box-shadow: 0 0 8px rgba(0,0,0,0.4);
  }
  h2 {
    border-bottom: 2px solid #333;
    padding-bottom: 6px;
    color: #6cf;
  }
  ul { list-style: none; padding: 0; margin-top: 10px; }
  li {
    background: #252525;
    margin: 8px 0;
    padding: 15px;
    border-radius: 6px;
    border-left: 4px solid #007bff;
  }
  .acoes { margin-top: 10px; }
  button, a {
    background: #007bff;
    border: none;
    color: white;
    padding: 8px 15px;
    margin-right: 8px;
    border-radius: 4px;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
    font-size: 0.9em;
  }
  button:hover, a:hover { background: #0056b3; }
  .baixar-tudo {
    display: block;
    width: 100%;
    background: #28a745;
    font-size: 1.1em;
    margin-top: 25px;
    padding: 15px;
  }
  .baixar-tudo:hover { background: #218838; }
  .msg { text-align: center; margin-top: 15px; font-style: italic; color: #ccc; }
  .loading { color: #6cf; }
  .error { color: #ff6b6b; }
  .success { color: #51cf66; }
  .arquivo-info { 
    display: flex; 
    justify-content: space-between; 
    align-items: center;
    flex-wrap: wrap;
  }
  .nome-arquivo { font-weight: bold; font-size: 1.1em; }
  .tamanho { color: #aaa; font-size: 0.9em; }
</style>
</head>
<body>
  <h1>🎧 Gerenciador de Listas M3U - Caverna do Rock</h1>

  <div class="categoria">
    <h2>🎶 Músicas</h2>
    <ul id="musicas"></ul>
  </div>

  <div class="categoria">
    <h2>🎤 Shows</h2>
    <ul id="shows"></ul>
  </div>

  <div class="categoria">
    <h2>📹 Videoclipes</h2>
    <ul id="video_clips"></ul>
  </div>

  <button class="baixar-tudo" onclick="baixarTodas()">📦 Baixar Todas as Listas</button>
  <button class="baixar-tudo" onclick="carregarListas()" style="background: #6f42c1; margin-top: 10px;">🔄 Atualizar Listas</button>

<script>
// Configurações
const CONFIG = {
  repo: 'cavernadorock69/cavernadorock69.github.io',
  branch: 'main',
  categorias: {
    musicas: 'musicas',
    shows: 'shows', 
    video_clips: 'video_clips'
  }
};

// URLs base
const RAW_BASE = `https://raw.githubusercontent.com/${CONFIG.repo}/${CONFIG.branch}`;
const GITHUB_API = `https://api.github.com/repos/${CONFIG.repo}/contents`;

async function carregarListas() {
  console.log('🔄 Iniciando carregamento de listas...');
  
  for (const [elementId, pasta] of Object.entries(CONFIG.categorias)) {
    const ul = document.getElementById(elementId);
    ul.innerHTML = '<li class="loading">🔄 Carregando listas M3U...</li>';
    
    try {
      console.log(`📁 Buscando arquivos em: ${pasta}`);
      
      const response = await fetch(`${GITHUB_API}/${pasta}`);
      
      if (!response.ok) {
        throw new Error(`Erro HTTP ${response.status}: ${response.statusText}`);
      }
      
      const dados = await response.json();
      console.log(`✅ Encontrados ${dados.length} itens em ${pasta}`, dados);
      
      // Filtrar apenas arquivos M3U/M3U8
      const arquivosM3U = dados.filter(item => 
        item.type === 'file' && 
        (item.name.toLowerCase().endsWith('.m3u') || 
         item.name.toLowerCase().endsWith('.m3u8'))
      );
      
      console.log(`🎵 ${arquivosM3U.length} arquivos M3U encontrados em ${pasta}`);
      
      if (arquivosM3U.length === 0) {
        ul.innerHTML = '<li class="msg">🎵 Nenhuma lista M3U encontrada nesta categoria.</li>';
        continue;
      }
      
      // Ordenar por nome
      arquivosM3U.sort((a, b) => a.name.localeCompare(b.name));
      
      ul.innerHTML = '';
      
      // Criar elementos para cada arquivo M3U
      arquivosM3U.forEach(arquivo => {
        const urlCompleta = `${RAW_BASE}/${pasta}/${encodeURIComponent(arquivo.name)}`;
        const urlDownload = arquivo.download_url || urlCompleta;
        
        const li = document.createElement('li');
        li.innerHTML = `
          <div class="arquivo-info">
            <div>
              <div class="nome-arquivo">${arquivo.name}</div>
              <div class="tamanho">${formatarTamanho(arquivo.size)}</div>
            </div>
            <div class="acoes">
              <a href="${urlDownload}" download="${arquivo.name}" title="Baixar lista">⬇️ Baixar</a>
              <button onclick="copiarURL('${urlCompleta}')" title="Copiar URL para player">📋 Copiar URL</button>
              <button onclick="visualizarLista('${urlCompleta}', '${arquivo.name}')" title="Visualizar conteúdo">👀 Visualizar</button>
            </div>
          </div>
        `;
        ul.appendChild(li);
      });
      
    } catch (error) {
      console.error(`❌ Erro ao carregar ${pasta}:`, error);
      ul.innerHTML = `
        <li class="error">
          ❌ Erro ao carregar listas: ${error.message}
          <br><small>Tentando método alternativo...</small>
        </li>
      `;
      
      // Tentar método alternativo
      await tentarMetodoAlternativo(elementId, pasta);
    }
  }
}

// Método alternativo caso a API falhe
async function tentarMetodoAlternativo(elementId, pasta) {
  try {
    const ul = document.getElementById(elementId);
    
    // Lista pré-definida de possíveis arquivos (fallback)
    const arquivosTeste = [
      'rock_classico.m3u', 'rock_anos_80.m3u', 'metal_pesado.m3u',
      'rock_brasileiro.m3u', 'rock_alternativo.m3u', 'show_acdc_live.m3u',
      'show_queen_wembley.m3u', 'show_iron_maiden.m3u', 'clips_rock_classico.m3u',
      'clips_metal.m3u'
    ];
    
    const arquivosEncontrados = [];
    
    // Testar cada arquivo
    for (const arquivo of arquivosTeste) {
      const urlTeste = `${RAW_BASE}/${pasta}/${arquivo}`;
      const response = await fetch(urlTeste, { method: 'HEAD' });
      
      if (response.ok) {
        arquivosEncontrados.push({
          name: arquivo,
          url: urlTeste
        });
      }
    }
    
    if (arquivosEncontrados.length > 0) {
      ul.innerHTML = '';
      arquivosEncontrados.forEach(arquivo => {
        const li = document.createElement('li');
        li.innerHTML = `
          <div class="arquivo-info">
            <div class="nome-arquivo">${arquivo.name}</div>
            <div class="acoes">
              <a href="${arquivo.url}" download="${arquivo.name}">⬇️ Baixar</a>
              <button onclick="copiarURL('${arquivo.url}')">📋 Copiar URL</button>
            </div>
          </div>
        `;
        ul.appendChild(li);
      });
      
      ul.innerHTML += `<li class="success">✅ ${arquivosEncontrados.length} listas carregadas (modo alternativo)</li>`;
    }
    
  } catch (error) {
    console.error('Erro no método alternativo:', error);
  }
}

function formatarTamanho(bytes) {
  if (!bytes) return 'Tamanho desconhecido';
  if (bytes < 1024) return bytes + ' bytes';
  if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / 1048576).toFixed(1) + ' MB';
}

function copiarURL(url) {
  navigator.clipboard.writeText(url).then(() => {
    alert('✅ URL copiada para a área de transferência!\n\n' + url);
  }).catch(err => {
    console.error('Erro ao copiar:', err);
    alert('❌ Erro ao copiar URL. Tente manualmente:\n\n' + url);
  });
}

async function visualizarLista(url, nome) {
  try {
    const response = await fetch(url);
    const conteudo = await response.text();
    
    // Criar popup para visualização
    const popup = window.open('', `Lista: ${nome}`, 'width=800,height=600');
    popup.document.write(`
      <html>
        <head>
          <title>📄 ${nome}</title>
          <style>
            body { font-family: Arial; padding: 20px; background: #f5f5f5; }
            pre { background: white; padding: 15px; border-radius: 5px; overflow-x: auto; }
            .header { background: #007bff; color: white; padding: 15px; border-radius: 5px; margin-bottom: 15px; }
          </style>
        </head>
        <body>
          <div class="header">
            <h2>📄 ${nome}</h2>
            <p>URL: ${url}</p>
          </div>
          <pre>${conteudo}</pre>
          <button onclick="window.print()">🖨️ Imprimir</button>
          <button onclick="window.close()">❌ Fechar</button>
        </body>
      </html>
    `);
  } catch (error) {
    alert('❌ Erro ao carregar conteúdo da lista: ' + error.message);
  }
}

async function baixarTodas() {
  let totalListas = 0;
  const todasListas = [];
  
  // Coletar todas as listas primeiro
  for (const [elementId, pasta] of Object.entries(CONFIG.categorias)) {
    const ul = document.getElementById(elementId);
    const itens = ul.querySelectorAll('a[download]');
    
    itens.forEach(a => {
      todasListas.push({
        url: a.href,
        nome: a.download,
        elemento: a
      });
    });
  }
  
  totalListas = todasListas.length;
  
  if (totalListas === 0) {
    alert('❌ Nenhuma lista disponível para download.');
    return;
  }
  
  alert(`📥 Iniciando download de ${totalListas} listas...`);
  
  // Baixar com intervalo para evitar bloqueio
  todasListas.forEach((lista, index) => {
    setTimeout(() => {
      console.log(`⬇️ Baixando: ${lista.nome}`);
      lista.elemento.click();
    }, index * 500);
  });
}

// Inicializar quando a página carregar
document.addEventListener('DOMContentLoaded', function() {
  console.log('🚀 Iniciando Gerenciador M3U...');
  carregarListas();
});

// Recarregar quando a página ganhar foco (útil se abrir em nova aba)
document.addEventListener('visibilitychange', function() {
  if (!document.hidden) {
    console.log('🔄 Página visível - verificando atualizações...');
    // Recarregar apenas se já passou algum tempo
    if (!this.lastLoad || Date.now() - this.lastLoad > 30000) {
      carregarListas();
      this.lastLoad = Date.now();
    }
  }
});
</script>
</body>
</html>
