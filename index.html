<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>R√°dio Caverna do Rock 69</title>
<style>
body {
  background: #111; color: #fff; font-family: Arial, sans-serif; margin: 0;
}
.header {
  background: #000; border-bottom: 2px solid #e94560; padding: 10px;
  text-align: center;
}
.logo { color: #e94560; font-size: 22px; font-weight: bold; }
.subtitle { font-size: 13px; color: #ccc; }

.container { padding: 10px; text-align: center; }
#search { width: 90%; max-width: 500px; padding: 8px; border: none; border-radius: 5px; margin-top: 10px; font-size: 14px; }

button {
  background: #333; color: #fff; border: none; border-radius: 5px;
  margin: 3px; padding: 8px 12px; font-size: 14px; cursor: pointer;
}
button:hover { background: #444; }
button.active { background: #e94560; }

.track-title { color: #e94560; margin-top: 10px; font-weight: bold; }
.track-artist { font-size: 14px; color: #ccc; }

.playlist { margin-top: 15px; max-height: 400px; overflow-y: auto; text-align: left; }
.artist { font-size: 16px; color: #e94560; margin-top: 10px; }
.album { font-size: 14px; margin-left: 15px; color: #ddd; }
.track { margin-left: 30px; padding: 4px; cursor: pointer; }
.track:hover { background: #222; }
.track.active { background: rgba(233,69,96,0.3); }
</style>
</head>
<body>
<div class="header">
  <div class="logo">üé∏ R√°dio Caverna do Rock 69</div>
  <div class="subtitle">A melhor sele√ß√£o de rock</div>
</div>

<div class="container">
  <input type="text" id="search" placeholder="üîç Buscar artista, √°lbum ou m√∫sica..." onkeyup="filterPlaylist()">
  <br>
  <audio id="player" controls style="width:100%; max-width:600px; margin-top:10px;"></audio>
  <div class="track-title" id="trackTitle">Carregando...</div>
  <div class="track-artist" id="trackArtist">-</div>
  <div class="controls">
    <button id="shuffleBtn" onclick="toggleShuffle()">üîÄ</button>
    <button onclick="prevTrack()">‚èÆ</button>
    <button onclick="togglePlay()">‚ñ∂/‚è∏</button>
    <button onclick="nextTrack()">‚è≠</button>
  </div>
  <div id="status" style="margin-top:10px;color:#aaa;">Carregando playlist...</div>

  <div class="playlist" id="playlist"></div>
</div>

<script>
var m3uUrl = "https://raw.githubusercontent.com/cavernadorock69/cavernadorock69.github.io/refs/heads/main/caverna_mp3.m3u";

var audio = document.getElementById("player");
var titleEl = document.getElementById("trackTitle");
var artistEl = document.getElementById("trackArtist");
var playlistEl = document.getElementById("playlist");
var statusEl = document.getElementById("status");
var shuffleBtn = document.getElementById("shuffleBtn");
var searchInput = document.getElementById("search");

var tracks = [];
var organized = {}; // { artista: { album: [faixas] } }
var flatList = []; // lista linear de todas as faixas (para tocar)
var current = -1;
var isShuffle = false;

function loadPlaylist() {
  var xhr = new XMLHttpRequest();
  xhr.open("GET", m3uUrl, true);
  xhr.onreadystatechange = function() {
    if (xhr.readyState == 4 && xhr.status == 200) {
      parseM3U(xhr.responseText);
      organizeTracks();
      renderPlaylist();
      if (flatList.length > 0) playTrack(0);
    }
  };
  xhr.send();
}

function parseM3U(text) {
  var lines = text.split(/\r?\n/);
  var currentArt = "Desconhecido";
  var currentAlb = "Desconhecido";
  var currentTitle = "";
  tracks = [];
  for (var i=0;i<lines.length;i++) {
    var line = lines[i].trim();
    if (!line) continue;
    if (line.indexOf("#EXTART:") == 0) currentArt = line.substring(8).trim();
    else if (line.indexOf("#EXTALB:") == 0) currentAlb = line.substring(8).trim();
    else if (line.indexOf("#EXTINF:") == 0) {
      var parts = line.split(",");
      currentTitle = parts.length > 1 ? parts[1].trim() : "Faixa desconhecida";
    }
    else if (line.indexOf("http") == 0) {
      tracks.push({ artist: currentArt, album: currentAlb, title: currentTitle, url: line });
    }
  }
}

function organizeTracks() {
  organized = {};
  flatList = [];
  for (var i=0;i<tracks.length;i++) {
    var t = tracks[i];
    if (!organized[t.artist]) organized[t.artist] = {};
    if (!organized[t.artist][t.album]) organized[t.artist][t.album] = [];
    organized[t.artist][t.album].push(t);
    flatList.push(t);
  }
}

function renderPlaylist(filter) {
  playlistEl.innerHTML = "";
  for (var art in organized) {
    var artistDiv = document.createElement("div");
    artistDiv.className = "artist";
    artistDiv.innerHTML = art;
    playlistEl.appendChild(artistDiv);

    var albums = organized[art];
    for (var alb in albums) {
      var albDiv = document.createElement("div");
      albDiv.className = "album";
      albDiv.innerHTML = alb;
      playlistEl.appendChild(albDiv);

      var faixas = albums[alb];
      for (var i=0;i<faixas.length;i++) {
        var f = faixas[i];
        if (filter && !matchFilter(f, filter)) continue;
        var tDiv = document.createElement("div");
        tDiv.className = "track";
        tDiv.innerHTML = f.title;
        tDiv.setAttribute("data-url", f.url);
        tDiv.onclick = function() {
          var idx = findIndexByUrl(this.getAttribute("data-url"));
          playTrack(idx);
        };
        playlistEl.appendChild(tDiv);
      }
    }
  }
  statusEl.innerHTML = flatList.length + " faixas carregadas.";
}

function matchFilter(f, text) {
  var s = text.toLowerCase();
  return f.title.toLowerCase().indexOf(s) >= 0 ||
         f.artist.toLowerCase().indexOf(s) >= 0 ||
         f.album.toLowerCase().indexOf(s) >= 0;
}

function filterPlaylist() {
  var text = searchInput.value.trim();
  if (text == "") renderPlaylist();
  else renderPlaylist(text);
}

function findIndexByUrl(url) {
  for (var i=0;i<flatList.length;i++) if (flatList[i].url == url) return i;
  return -1;
}

function playTrack(i) {
  if (i<0 || i>=flatList.length) return;
  current = i;
  var t = flatList[i];
  audio.src = t.url;
  audio.play();
  titleEl.innerHTML = t.title;
  artistEl.innerHTML = t.artist + " ‚Äî " + t.album;
  updateActive();
}

function updateActive() {
  var all = playlistEl.getElementsByClassName("track");
  for (var j=0;j<all.length;j++) {
    all[j].className = "track" + (flatList[j] && flatList[j].url == flatList[current].url ? " active" : "");
  }
}

function togglePlay() {
  if (audio.paused) audio.play();
  else audio.pause();
}

function nextTrack() {
  if (isShuffle) {
    var newIndex = current;
    while (newIndex == current && flatList.length > 1)
      newIndex = Math.floor(Math.random()*flatList.length);
    playTrack(newIndex);
  } else {
    current++;
    if (current >= flatList.length) current = 0;
    playTrack(current);
  }
}

function prevTrack() {
  if (isShuffle) {
    var newIndex = current;
    while (newIndex == current && flatList.length > 1)
      newIndex = Math.floor(Math.random()*flatList.length);
    playTrack(newIndex);
  } else {
    current--;
    if (current < 0) current = flatList.length-1;
    playTrack(current);
  }
}

function toggleShuffle() {
  isShuffle = !isShuffle;
  shuffleBtn.className = isShuffle ? "active" : "";
  statusEl.innerHTML = isShuffle ? "Modo aleat√≥rio ligado." : "Modo normal.";
}

audio.addEventListener("ended", function() { nextTrack(); });
window.onload = function() { loadPlaylist(); };
</script>
</body>
</html>
