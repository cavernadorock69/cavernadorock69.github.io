<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Player Retr√¥ Winamp Style</title>
<style>
  body {
    background-color: #111;
    color: #0f0;
    font-family: monospace;
    margin: 0;
    padding: 20px;
  }
  #player-container {
    background: #222;
    border: 2px solid #0f0;
    padding: 10px;
    max-width: 1000px;
    margin: auto;
    display: flex;
    flex-direction: column;
  }
  #main-content {
    display: flex;
    gap: 15px;
  }
  #left-panel {
    flex: 1;
  }
  #right-panel {
    width: 300px;
    display: flex;
    flex-direction: column;
  }
  #controls {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 5px;
    margin-bottom: 10px;
  }
  #controls button {
    background: #333;
    border: 1px solid #0f0;
    color: #0f0;
    padding: 5px 10px;
    cursor: pointer;
  }
  #controls button:hover {
    background: #0f0;
    color: #000;
  }
  #filters {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    margin-bottom: 10px;
  }
  #filters button {
    background: #111;
    border: 1px solid #0f0;
    color: #0f0;
    padding: 5px 10px;
    cursor: pointer;
  }
  #filters button.active {
    background: #0f0;
    color: #000;
  }
  #search {
    width: 100%;
    padding: 5px;
    background: #111;
    border: 1px solid #0f0;
    color: #0f0;
    margin-bottom: 10px;
  }
  #playlist {
    max-height: 400px;
    overflow-y: auto;
    background: #000;
    border: 1px solid #0f0;
    padding: 5px;
  }
  .track {
    padding: 4px;
    cursor: pointer;
  }
  .track:hover {
    background: #0f0;
    color: #000;
  }
  .playing {
    background: #060;
  }
  #video-container {
    background: #000;
    border: 1px solid #0f0;
    margin-bottom: 10px;
  }
  #videoPlayer {
    width: 100%;
    max-height: 170px;
    background: #000;
    display: none; /* Inicialmente escondido */
  }
  #audioPlayer {
    width: 100%;
    display: none; /* Inicialmente escondido */
  }
  #closeFullscreen {
    display: none;
    position: fixed;
    top: 10px;
    right: 20px;
    background: #f00;
    color: #fff;
    font-weight: bold;
    padding: 5px 10px;
    cursor: pointer;
    z-index: 9999;
  }
  #status {
    color: #ff0;
    font-size: 12px;
    margin-top: 5px;
  }
  #now-playing {
    margin-bottom: 10px;
    padding: 5px;
    background: #000;
    border: 1px solid #0f0;
  }
  #random-btn {
    margin-left: auto;
    background: #111 !important;
  }
  #random-btn.active {
    background: #0f0 !important;
    color: #000 !important;
  }
  .loading {
    color: #ff0;
    font-style: italic;
  }
  .player-active {
    display: block !important; /* Classe para mostrar o player ativo */
  }
  @media (max-width: 768px) {
    #main-content {
      flex-direction: column;
    }
    #right-panel {
      width: 100%;
    }
    #videoPlayer {
      max-height: 200px;
    }
  }
</style>
</head>
<body>
<div id="player-container">
  <div id="now-playing">Carregando biblioteca...</div>
  <div id="status"></div>

  <div id="controls">
    <button onclick="prevTrack()">‚èÆ</button>
    <button id="playPauseBtn" onclick="togglePlay()">‚ñ∂Ô∏è</button>
    <button onclick="stopTrack()">‚èπ</button>
    <button onclick="nextTrack()">‚è≠</button>
    <button id="random-btn" onclick="toggleRandom()">üîÄ Aleat√≥rio</button>
  </div>

  <div id="filters">
    <button onclick="setFilter('all')" class="active">Todos</button>
    <button onclick="setFilter('mp3')">MP3</button>
    <button onclick="setFilter('mp4')">Clips</button>
  </div>

  <div id="main-content">
    <div id="left-panel">
      <input type="text" id="search" placeholder="üîç Buscar m√∫sica/clipe..." oninput="debouncedRenderPlaylist()">
      <div id="playlist"></div>
    </div>
    
    <div id="right-panel">
      <div id="video-container">
        <video id="videoPlayer" controls preload="metadata">
          Seu navegador n√£o suporta v√≠deo HTML5.
        </video>
      </div>
      <audio id="audioPlayer" controls preload="metadata">
        Seu navegador n√£o suporta √°udio HTML5.
      </audio>
    </div>
  </div>
</div>

<button id="closeFullscreen" onclick="exitFullscreen()">[X] Fechar</button>

<script>
// Configura√ß√µes para compatibilidade
var COMPATIBILITY = {
  USE_LEGACY_VIDEO: true,
  FORCE_SIMPLE_AUDIO: false,
  TIMEOUT_LOAD: 30000,
  RETRY_ATTEMPTS: 2
};

var repositories = [
  "https://api.github.com/repos/cavernadorock69/cavernadorock69.github.io/contents/minhas_cole%C3%A7%C3%B5es",
  "https://api.github.com/repos/cavernadorock69/cavernadorock69.github.io/contents/outras_cole%C3%A7%C3%B5es",
  "https://api.github.com/repos/cavernadorock69/cavernadorock69.github.io/contents/clips_e_shows"
];

var library = [];
var currentTrack = -1;
var filterType = "all";
var playerState = 'stopped';
var debounceTimer;
var randomMode = false;
var userInteracted = false;
var currentRetryCount = 0;
var currentMediaType = null; // 'audio' ou 'video'

// Elementos DOM
var audioPlayer = document.getElementById("audioPlayer");
var videoPlayer = document.getElementById("videoPlayer");
var closeBtn = document.getElementById("closeFullscreen");
var nowPlaying = document.getElementById("now-playing");
var statusDiv = document.getElementById("status");
var playlistDiv = document.getElementById("playlist");
var playPauseBtn = document.getElementById("playPauseBtn");
var randomBtn = document.getElementById("random-btn");

// Detectar capacidades do navegador
var browserCapabilities = {
  canPlayMP4: videoPlayer.canPlayType('video/mp4') !== '',
  canPlayMP3: audioPlayer.canPlayType('audio/mpeg') !== '',
  hasPromise: typeof Promise !== 'undefined',
  hasFetch: typeof fetch !== 'undefined'
};

// Configurar players para m√°xima compatibilidade
function setupPlayers() {
  // Remover atributos problem√°ticos para navegadores antigos
  audioPlayer.removeAttribute('crossorigin');
  videoPlayer.removeAttribute('crossorigin');
  
  // Configura√ß√µes conservadoras para performance
  audioPlayer.preload = 'metadata';
  videoPlayer.preload = 'metadata';
  audioPlayer.volume = 0.7;
  videoPlayer.volume = 0.7;
  
  // Event listeners simplificados
  audioPlayer.addEventListener('ended', handleMediaEnded);
  audioPlayer.addEventListener('error', handleAudioError);
  audioPlayer.addEventListener('canplay', handleAudioReady);
  
  videoPlayer.addEventListener('ended', handleMediaEnded);
  videoPlayer.addEventListener('error', handleVideoError);
  videoPlayer.addEventListener('canplay', handleVideoReady);
  videoPlayer.addEventListener('loadstart', handleVideoLoadStart);
}

// Verificar se √© uma Smart TV ou navegador antigo
function isLegacyBrowser() {
  var ua = navigator.userAgent.toLowerCase();
  return ua.includes('tv') || 
         ua.includes('smart') || 
         ua.includes('xbox') ||
         ua.includes('playstation') ||
         /msie|trident|edge\//.test(ua) ||
         !browserCapabilities.hasPromise;
}

// Inicializar com configura√ß√µes apropriadas
if (isLegacyBrowser()) {
  COMPATIBILITY.USE_LEGACY_VIDEO = true;
  COMPATIBILITY.FORCE_SIMPLE_AUDIO = true;
  statusDiv.innerHTML = '<span class="loading">Modo de compatibilidade ativado</span>';
}

setupPlayers();

// Fun√ß√£o para parar completamente a reprodu√ß√£o atual
function stopCurrentPlayback() {
  console.log('Parando reprodu√ß√£o atual. Tipo anterior:', currentMediaType);
  
  // Parar e resetar ambos os players
  if (audioPlayer) {
    audioPlayer.pause();
    audioPlayer.currentTime = 0;
    audioPlayer.src = '';
    audioPlayer.load();
    audioPlayer.style.display = 'none';
    audioPlayer.classList.remove('player-active');
  }
  
  if (videoPlayer) {
    videoPlayer.pause();
    videoPlayer.currentTime = 0;
    
    // Limpar sources de v√≠deo
    while (videoPlayer.firstChild) {
      videoPlayer.removeChild(videoPlayer.firstChild);
    }
    
    videoPlayer.load();
    videoPlayer.style.display = 'none';
    videoPlayer.classList.remove('player-active');
    
    // Sair da tela cheia se estiver
    if (document.fullscreenElement) {
      exitFullscreen();
    }
  }
  
  currentMediaType = null;
}

function loadPlaylists() {
  statusDiv.innerHTML = '<span class="loading">Carregando playlists...</span>';
  var pending = repositories.length;
  
  if (pending === 0) {
    statusDiv.textContent = "Nenhum reposit√≥rio configurado";
    return;
  }
  
  repositories.forEach(function(repoUrl){
    var xhr = new XMLHttpRequest();
    xhr.timeout = COMPATIBILITY.TIMEOUT_LOAD;
    xhr.open("GET", repoUrl, true);
    
    xhr.onreadystatechange = function(){
      if (xhr.readyState === 4) {
        if (xhr.status >= 200 && xhr.status < 300) {
          try {
            var files = JSON.parse(xhr.responseText);
            files.forEach(function(f){
              if (f && f.name && f.name.toLowerCase().endsWith(".m3u") && f.download_url) {
                fetchM3u(f.download_url);
              }
            });
          } catch(e){
            console.error("Erro ao processar reposit√≥rio:", e);
          }
        } else {
          statusDiv.textContent = "Erro ao carregar: " + repoUrl;
        }
        pending--;
        if (pending === 0) {
          statusDiv.textContent = "Playlists carregadas. " + library.length + " itens encontrados.";
          renderPlaylist();
        }
      }
    };
    
    xhr.ontimeout = function() {
      pending--;
      statusDiv.textContent = "Timeout ao carregar: " + repoUrl;
      if (pending === 0) renderPlaylist();
    };
    
    xhr.onerror = function() {
      pending--;
      statusDiv.textContent = "Falha na conex√£o: " + repoUrl;
      if (pending === 0) renderPlaylist();
    };
    
    xhr.send();
  });
}

function fetchM3u(url) {
  var xhr = new XMLHttpRequest();
  xhr.timeout = COMPATIBILITY.TIMEOUT_LOAD;
  xhr.open("GET", url, true);
  
  xhr.onreadystatechange = function(){
    if (xhr.readyState === 4){
      if (xhr.status >= 200 && xhr.status < 300){
        parseM3u(xhr.responseText);
      } else {
        console.error("Erro ao carregar M3U:", url);
      }
    }
  };
  
  xhr.ontimeout = function() {
    console.error("Timeout ao carregar M3U:", url);
  };
  
  xhr.onerror = function() {
    console.error("Erro de conex√£o ao carregar M3U:", url);
  };
  
  xhr.send();
}

function parseM3u(text) {
  var lines = text.split(/\r?\n/);
  var artist = "", title = "", duration = "";
  
  for (var i = 0; i < lines.length; i++) {
    var line = lines[i].trim();
    if (!line) continue;
    
    if (line.startsWith("#EXTINF:")) {
      var info = line.substring(8).split(",");
      duration = info[0] || "";
      var name = info[1] || "";
      var parts = name.split(" - ");
      artist = parts[0] || "Desconhecido";
      title = parts[1] || name;
    } else if (!line.startsWith("#")) {
      var url = line;
      var ext = url.split("?")[0].split(".").pop().toLowerCase();
      
      if ((ext === "mp4" && browserCapabilities.canPlayMP4) || 
          (ext === "mp3" && browserCapabilities.canPlayMP3) ||
          (ext !== "mp4" && ext !== "mp3")) {
        library.push({
          artist: artist, 
          title: title, 
          url: url, 
          type: ext,
          duration: duration
        });
      }
      artist = ""; title = ""; duration = "";
    }
  }
}

function renderPlaylist() {
  playlistDiv.innerHTML = "";
  var search = document.getElementById("search").value.toLowerCase();
  
  if (library.length === 0) {
    playlistDiv.innerHTML = "<div class='track'>Nenhuma m√∫sica encontrada</div>";
    return;
  }
  
  var filteredTracks = library.filter(function(track) {
    if (filterType !== "all" && track.type !== filterType) return false;
    if (search && !(track.title.toLowerCase().includes(search) || track.artist.toLowerCase().includes(search))) return false;
    return true;
  });
  
  if (filteredTracks.length === 0) {
    playlistDiv.innerHTML = "<div class='track'>Nenhum resultado encontrado</div>";
    return;
  }
  
  filteredTracks.forEach(function(track, index) {
    var originalIndex = library.indexOf(track);
    var div = document.createElement("div");
    div.className = "track" + (originalIndex === currentTrack ? " playing" : "");
    
    var trackText = (index + 1) + ". " + track.artist + " - " + track.title;
    if (track.duration) {
      trackText += " [" + track.duration + "]";
    }
    
    div.textContent = trackText;
    div.onclick = function(){ playTrack(originalIndex); };
    playlistDiv.appendChild(div);
  });
}

function debouncedRenderPlaylist() {
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(renderPlaylist, 300);
}

function playTrack(index) {
  if (index < 0 || index >= library.length) return;
  
  console.log('Iniciando reprodu√ß√£o do track:', index);
  
  currentTrack = index;
  var track = library[index];
  nowPlaying.textContent = "Tocando: " + track.artist + " - " + track.title;
  statusDiv.innerHTML = '<span class="loading">Carregando...</span>';
  
  currentRetryCount = 0;
  
  // Parar completamente qualquer reprodu√ß√£o anterior
  stopCurrentPlayback();
  
  // Pequeno delay para garantir que o player anterior foi parado
  setTimeout(function() {
    executePlayback(track);
  }, 200);
}

function executePlayback(track) {
  try {
    if (track.type === "mp4" && browserCapabilities.canPlayMP4) {
      playVideo(track);
    } else {
      playAudio(track);
    }
  } catch (error) {
    handlePlaybackError(error, track);
  }
}

function playVideo(track) {
  console.log('Preparando v√≠deo:', track.title);
  currentMediaType = 'video';
  
  // Esconder √°udio e mostrar v√≠deo
  audioPlayer.style.display = "none";
  videoPlayer.style.display = "block";
  videoPlayer.classList.add('player-active');
  
  // Limpar sources anteriores
  while (videoPlayer.firstChild) {
    videoPlayer.removeChild(videoPlayer.firstChild);
  }
  
  // Adicionar novo source
  var source = document.createElement('source');
  source.src = track.url;
  source.type = 'video/mp4';
  videoPlayer.appendChild(source);
  
  videoPlayer.load();
}

function playAudio(track) {
  console.log('Preparando √°udio:', track.title);
  currentMediaType = 'audio';
  
  // Esconder v√≠deo e mostrar √°udio
  videoPlayer.style.display = "none";
  audioPlayer.style.display = "block";
  audioPlayer.classList.add('player-active');
  
  // Garantir que sa√≠mos da tela cheia para √°udio
  if (document.fullscreenElement) {
    exitFullscreen();
  }
  
  audioPlayer.src = track.url;
  audioPlayer.load();
}

function handleVideoLoadStart() {
  statusDiv.textContent = "Preparando v√≠deo...";
}

function handleVideoReady() {
  statusDiv.textContent = "V√≠deo pronto";
  attemptPlayback(videoPlayer, 'video');
}

function handleAudioReady() {
  statusDiv.textContent = "√Åudio pronto";
  attemptPlayback(audioPlayer, 'audio');
}

function attemptPlayback(mediaElement, mediaType) {
  if (!userInteracted) {
    statusDiv.textContent = "Clique para reproduzir";
    playerState = 'paused';
    updatePlayButton();
    return;
  }
  
  var playPromise = mediaElement.play();
  
  if (playPromise !== undefined) {
    playPromise.then(function() {
      playerState = 'playing';
      statusDiv.textContent = "Reproduzindo";
      updatePlayButton();
      
      // Apenas entrar em tela cheia para v√≠deo
      if (mediaType === 'video' && mediaElement.requestFullscreen) {
        mediaElement.requestFullscreen().catch(function(err) {
          console.log("Tela cheia n√£o dispon√≠vel");
        });
        closeBtn.style.display = "block";
      }
    }).catch(function(error) {
      statusDiv.textContent = "Clique no player para reproduzir";
      playerState = 'paused';
      updatePlayButton();
    });
  } else {
    // Fallback para navegadores sem Promise
    try {
      mediaElement.play();
      playerState = 'playing';
      statusDiv.textContent = "Reproduzindo";
      updatePlayButton();
    } catch (error) {
      statusDiv.textContent = "Clique para reproduzir";
      playerState = 'paused';
      updatePlayButton();
    }
  }
}

function handleAudioError() {
  console.error('Erro de √°udio');
  statusDiv.textContent = "Erro de √°udio";
  retryPlayback();
}

function handleVideoError() {
  console.error('Erro de v√≠deo');
  statusDiv.textContent = "Erro de v√≠deo";
  retryPlayback();
}

function handlePlaybackError(error, track) {
  console.error("Erro na reprodu√ß√£o:", error);
  statusDiv.textContent = "Erro: " + (error.message || "Falha na reprodu√ß√£o");
  retryPlayback();
}

function retryPlayback() {
  if (currentRetryCount < COMPATIBILITY.RETRY_ATTEMPTS && currentTrack >= 0) {
    currentRetryCount++;
    statusDiv.textContent = "Tentativa " + currentRetryCount + " de " + COMPATIBILITY.RETRY_ATTEMPTS;
    
    setTimeout(function() {
      var track = library[currentTrack];
      executePlayback(track);
    }, 1000);
  } else {
    playerState = 'stopped';
    updatePlayButton();
  }
}

function stopTrack() {
  stopCurrentPlayback();
  playerState = 'stopped';
  statusDiv.textContent = "Parado";
  updatePlayButton();
  currentTrack = -1;
  renderPlaylist();
}

function togglePlay() {
  if (currentTrack === -1) {
    if (library.length > 0) {
      playTrack(0);
    }
    return;
  }
  
  if (playerState === 'playing') {
    // Pausar o player ativo atual
    if (currentMediaType === 'audio' && audioPlayer) {
      audioPlayer.pause();
    } else if (currentMediaType === 'video' && videoPlayer) {
      videoPlayer.pause();
    }
    playerState = 'paused';
    statusDiv.textContent = "Pausado";
  } else {
    // Retomar o player ativo atual
    if (currentMediaType === 'audio' && audioPlayer) {
      attemptPlayback(audioPlayer, 'audio');
    } else if (currentMediaType === 'video' && videoPlayer) {
      attemptPlayback(videoPlayer, 'video');
    }
  }
  updatePlayButton();
}

function updatePlayButton() {
  playPauseBtn.textContent = playerState === 'playing' ? '‚è∏' : '‚ñ∂Ô∏è';
}

function prevTrack() {
  if (library.length === 0) return;
  
  if (randomMode) {
    playRandomTrack();
    return;
  }
  
  var newIndex = currentTrack > 0 ? currentTrack - 1 : library.length - 1;
  playTrack(newIndex);
}

function nextTrack() {
  if (library.length === 0) return;
  
  if (randomMode) {
    playRandomTrack();
    return;
  }
  
  var newIndex = currentTrack < library.length - 1 ? currentTrack + 1 : 0;
  playTrack(newIndex);
}

function handleMediaEnded() {
  console.log('M√≠dia terminou, tipo:', currentMediaType);
  if (randomMode) {
    playRandomTrack();
  } else {
    nextTrack();
  }
}

function playRandomTrack() {
  if (library.length === 0) return;
  
  var search = document.getElementById("search").value.toLowerCase();
  var filteredTracks = library.filter(function(track) {
    if (filterType !== "all" && track.type !== filterType) return false;
    if (search && !(track.title.toLowerCase().includes(search) || track.artist.toLowerCase().includes(search))) return false;
    return true;
  });
  
  if (filteredTracks.length === 0) return;
  
  if (filteredTracks.length === 1) {
    var trackIndex = library.indexOf(filteredTracks[0]);
    playTrack(trackIndex);
    return;
  }
  
  var currentFilteredIndex = filteredTracks.findIndex(track => library.indexOf(track) === currentTrack);
  var randomIndex;
  do {
    randomIndex = Math.floor(Math.random() * filteredTracks.length);
  } while (randomIndex === currentFilteredIndex && filteredTracks.length > 1);
  
  var trackIndex = library.indexOf(filteredTracks[randomIndex]);
  playTrack(trackIndex);
}

function toggleRandom() {
  randomMode = !randomMode;
  randomBtn.classList.toggle('active', randomMode);
  statusDiv.textContent = randomMode ? "Modo aleat√≥rio ativado" : "Modo aleat√≥rio desativado";
}

function setFilter(type) {
  filterType = type;
  document.querySelectorAll("#filters button").forEach(btn => btn.classList.remove("active"));
  var buttons = document.querySelectorAll("#filters button");
  for (var i = 0; i < buttons.length; i++) {
    if (buttons[i].textContent.toLowerCase().includes(type)) {
      buttons[i].classList.add("active");
      break;
    }
  }
  renderPlaylist();
}

function exitFullscreen() {
  if (document.fullscreenElement) {
    document.exitFullscreen().catch(function(err) {
      console.log("Erro ao sair da tela cheia:", err);
    });
  }
  closeBtn.style.display = "none";
}

// Inicializar quando o DOM estiver pronto
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', loadPlaylists);
} else {
  loadPlaylists();
}

// Marcar intera√ß√£o do usu√°rio para autoplay
document.addEventListener('click', function() {
  if (!userInteracted) {
    userInteracted = true;
    console.log('Usu√°rio interagiu com a p√°gina');
  }
}, { once: true });
</script>
</body>
</html>
