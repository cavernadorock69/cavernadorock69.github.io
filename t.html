<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Player Retr√¥ Winamp Style</title>
<style>
  body {
    background-color: #111;
    color: #0f0;
    font-family: monospace;
    margin: 0;
    padding: 20px;
  }
  #player-container {
    background: #222;
    border: 2px solid #0f0;
    padding: 10px;
    max-width: 1000px;
    margin: auto;
    display: flex;
    flex-direction: column;
  }
  #main-content {
    display: flex;
    gap: 15px;
  }
  #left-panel {
    flex: 1;
  }
  #right-panel {
    width: 300px;
    display: flex;
    flex-direction: column;
  }
  #controls {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 5px;
    margin-bottom: 10px;
  }
  #controls button {
    background: #333;
    border: 1px solid #0f0;
    color: #0f0;
    padding: 5px 10px;
    cursor: pointer;
  }
  #controls button:hover {
    background: #0f0;
    color: #000;
  }
  #filters {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    margin-bottom: 10px;
  }
  #filters button {
    background: #111;
    border: 1px solid #0f0;
    color: #0f0;
    padding: 5px 10px;
    cursor: pointer;
  }
  #filters button.active {
    background: #0f0;
    color: #000;
  }
  #search {
    width: 100%;
    padding: 5px;
    background: #111;
    border: 1px solid #0f0;
    color: #0f0;
    margin-bottom: 10px;
  }
  #playlist {
    max-height: 400px;
    overflow-y: auto;
    background: #000;
    border: 1px solid #0f0;
    padding: 5px;
  }
  .track {
    padding: 4px;
    cursor: pointer;
  }
  .track:hover {
    background: #0f0;
    color: #000;
  }
  .playing {
    background: #060;
  }
  #video-container {
    background: #000;
    border: 1px solid #0f0;
    margin-bottom: 10px;
  }
  #videoPlayer {
    width: 100%;
    max-height: 170px;
    background: #000;
  }
  #audioPlayer {
    width: 100%;
  }
  #closeFullscreen {
    display: none;
    position: fixed;
    top: 10px;
    right: 20px;
    background: #f00;
    color: #fff;
    font-weight: bold;
    padding: 5px 10px;
    cursor: pointer;
    z-index: 9999;
  }
  #status {
    color: #ff0;
    font-size: 12px;
    margin-top: 5px;
  }
  #now-playing {
    margin-bottom: 10px;
    padding: 5px;
    background: #000;
    border: 1px solid #0f0;
  }
  #random-btn {
    margin-left: auto;
    background: #111 !important;
  }
  #random-btn.active {
    background: #0f0 !important;
    color: #000 !important;
  }
  @media (max-width: 768px) {
    #main-content {
      flex-direction: column;
    }
    #right-panel {
      width: 100%;
    }
    #videoPlayer {
      max-height: 200px;
    }
  }
</style>
</head>
<body>
<div id="player-container">
  <div id="now-playing">Carregando biblioteca...</div>
  <div id="status"></div>

  <div id="controls">
    <button onclick="prevTrack()">‚èÆ</button>
    <button id="playPauseBtn" onclick="togglePlay()">‚ñ∂Ô∏è</button>
    <button onclick="stopTrack()">‚èπ</button>
    <button onclick="nextTrack()">‚è≠</button>
    <button id="random-btn" onclick="toggleRandom()">üîÄ Aleat√≥rio</button>
  </div>

  <div id="filters">
    <button onclick="setFilter('all')" class="active">Todos</button>
    <button onclick="setFilter('mp3')">MP3</button>
    <button onclick="setFilter('wav')">WAV</button>
    <button onclick="setFilter('flac')">FLAC</button>
    <button onclick="setFilter('mp4')">Clips</button>
  </div>

  <div id="main-content">
    <div id="left-panel">
      <input type="text" id="search" placeholder="üîç Buscar m√∫sica/clipe..." oninput="debouncedRenderPlaylist()">
      <div id="playlist"></div>
    </div>
    
    <div id="right-panel">
      <div id="video-container">
        <video id="videoPlayer" controls>
          <source id="videoSource" type="video/mp4">
        </video>
      </div>
      <audio id="audioPlayer" controls></audio>
    </div>
  </div>
</div>

<button id="closeFullscreen" onclick="exitFullscreen()">[X] Fechar</button>

<script>
var repositories = [
  "https://api.github.com/repos/cavernadorock69/cavernadorock69.github.io/contents/minhas_cole%C3%A7%C3%B5es",
  "https://api.github.com/repos/cavernadorock69/cavernadorock69.github.io/contents/outras_cole%C3%A7%C3%B5es",
  "https://api.github.com/repos/cavernadorock69/cavernadorock69.github.io/contents/clips_e_shows"
];

var library = [];
var currentTrack = -1;
var filterType = "all";
var playerState = 'stopped';
var debounceTimer;
var randomMode = false;
var userInteracted = false;

var audioPlayer = document.getElementById("audioPlayer");
var videoPlayer = document.getElementById("videoPlayer");
var videoSource = document.getElementById("videoSource");
var closeBtn = document.getElementById("closeFullscreen");
var nowPlaying = document.getElementById("now-playing");
var statusDiv = document.getElementById("status");
var playlistDiv = document.getElementById("playlist");
var playPauseBtn = document.getElementById("playPauseBtn");
var randomBtn = document.getElementById("random-btn");

// Adiciona event listeners para detectar o fim da reprodu√ß√£o
audioPlayer.addEventListener('ended', handleMediaEnded);
videoPlayer.addEventListener('ended', handleMediaEnded);

// Adiciona tratamento de erros
audioPlayer.addEventListener('error', function() {
  statusDiv.textContent = "Erro ao reproduzir √°udio";
  playerState = 'stopped';
  updatePlayButton();
});

videoPlayer.addEventListener('error', function() {
  statusDiv.textContent = "Erro ao reproduzir v√≠deo";
  playerState = 'stopped';
  updatePlayButton();
});

// Marcar que o usu√°rio interagiu com a p√°gina (necess√°rio para autoplay)
document.addEventListener('click', function() {
  userInteracted = true;
}, { once: true });

function loadPlaylists() {
  statusDiv.textContent = "Carregando playlists...";
  var pending = repositories.length;
  
  if (pending === 0) {
    statusDiv.textContent = "Nenhum reposit√≥rio configurado";
    return;
  }
  
  repositories.forEach(function(repoUrl){
    var xhr = new XMLHttpRequest();
    xhr.open("GET", repoUrl, true);
    xhr.onreadystatechange = function(){
      if (xhr.readyState === 4) {
        if (xhr.status >=200 && xhr.status < 300) {
          try {
            var files = JSON.parse(xhr.responseText);
            files.forEach(function(f){
              if (f && f.name && f.name.toLowerCase().endsWith(".m3u") && f.download_url) {
                fetchM3u(f.download_url);
              }
            });
          } catch(e){
            console.error("Erro ao processar reposit√≥rio:", e);
          }
        } else {
          statusDiv.textContent = "Erro ao carregar: " + repoUrl;
        }
        pending--;
        if (pending===0) {
          statusDiv.textContent = "Playlists carregadas. " + library.length + " itens encontrados.";
          renderPlaylist();
        }
      }
    };
    xhr.onerror = function() {
      pending--;
      statusDiv.textContent = "Falha na conex√£o ao carregar: " + repoUrl;
      if (pending===0) renderPlaylist();
    };
    xhr.send();
  });
}

function fetchM3u(url) {
  var xhr = new XMLHttpRequest();
  xhr.open("GET", url, true);
  xhr.onreadystatechange = function(){
    if (xhr.readyState === 4){
      if (xhr.status>=200 && xhr.status<300){
        parseM3u(xhr.responseText);
      } else {
        console.error("Erro ao carregar M3U:", url);
      }
    }
  };
  xhr.onerror = function() {
    console.error("Erro de conex√£o ao carregar M3U:", url);
  };
  xhr.send();
}

function parseM3u(text) {
  var lines = text.split(/\r?\n/);
  var artist="", title="";
  for (var i=0;i<lines.length;i++) {
    var line = lines[i].trim();
    if (!line) continue;
    if (line.startsWith("#EXTINF:")) {
      var info = line.split(",")[1] || "";
      var parts = info.split(" - ");
      artist = parts[0] || "Desconhecido";
      title = parts[1] || info;
    } else if (!line.startsWith("#")) {
      var url = line;
      var ext = url.split("?")[0].split(".").pop().toLowerCase();
      library.push({artist:artist, title:title, url:url, type:ext});
      artist=""; title="";
    }
  }
}

function renderPlaylist() {
  playlistDiv.innerHTML = "";
  var search = document.getElementById("search").value.toLowerCase();
  
  if (library.length === 0) {
    playlistDiv.innerHTML = "<div class='track'>Nenhuma m√∫sica encontrada</div>";
    return;
  }
  
  var filteredTracks = library.filter(function(track) {
    if (filterType!=="all" && track.type!==filterType) return false;
    if (search && !(track.title.toLowerCase().includes(search) || track.artist.toLowerCase().includes(search))) return false;
    return true;
  });
  
  if (filteredTracks.length === 0) {
    playlistDiv.innerHTML = "<div class='track'>Nenhum resultado encontrado</div>";
    return;
  }
  
  filteredTracks.forEach(function(track, index){
    var originalIndex = library.indexOf(track);
    var div = document.createElement("div");
    div.className = "track" + (originalIndex===currentTrack?" playing":"");
    div.textContent = (index+1)+". "+track.artist+" - "+track.title;
    div.onclick = function(){ playTrack(originalIndex); };
    playlistDiv.appendChild(div);
  });
}

// Debounce para evitar m√∫ltiplas renderiza√ß√µes durante a digita√ß√£o
function debouncedRenderPlaylist() {
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(renderPlaylist, 300);
}

function playTrack(index) {
  if (index < 0 || index >= library.length) return;
  
  currentTrack = index;
  var track = library[index];
  nowPlaying.textContent = "Tocando: "+track.artist+" - "+track.title;
  statusDiv.textContent = "Carregando...";

  // Pausar e resetar players
  audioPlayer.pause();
  videoPlayer.pause();
  
  // Limpar src anteriores para evitar conflitos
  audioPlayer.src = "";
  videoSource.src = "";

  try {
    if (track.type==="mp4") {
      // Esconder √°udio e mostrar v√≠deo
      audioPlayer.style.display = "none";
      videoPlayer.style.display = "block";
      
      videoSource.src = track.url;
      videoPlayer.load();
      
      videoPlayer.oncanplay = function() {
        statusDiv.textContent = "Reproduzindo v√≠deo";
        
        // Tentar reproduzir automaticamente se o usu√°rio j√° interagiu com a p√°gina
        if (userInteracted) {
          var playPromise = videoPlayer.play();
          
          if (playPromise !== undefined) {
            playPromise.then(function() {
              // Reprodu√ß√£o iniciada com sucesso
              playerState = 'playing';
              updatePlayButton();
              
              // Entrar em tela cheia automaticamente para v√≠deos
              if (videoPlayer.requestFullscreen) {
                videoPlayer.requestFullscreen().catch(function(err) {
                  console.error("Erro ao entrar em tela cheia:", err);
                });
                closeBtn.style.display="block";
              }
            }).catch(function(error) {
              // Autoplay foi prevenido, mostrar bot√£o de play
              statusDiv.textContent = "Clique no player para reproduzir";
              playerState = 'paused';
              updatePlayButton();
            });
          }
        } else {
          statusDiv.textContent = "Clique no player para reproduzir";
          playerState = 'paused';
          updatePlayButton();
        }
      };
      
    } else {
      // Esconder v√≠deo e mostrar √°udio
      videoPlayer.style.display = "none";
      audioPlayer.style.display = "block";
      
      audioPlayer.src = track.url;
      
      audioPlayer.oncanplay = function() {
        statusDiv.textContent = "Reproduzindo √°udio";
        
        // Para √°udio, tentar reproduzir automaticamente
        if (userInteracted) {
          var playPromise = audioPlayer.play();
          
          if (playPromise !== undefined) {
            playPromise.then(function() {
              playerState = 'playing';
              updatePlayButton();
            }).catch(function(error) {
              statusDiv.textContent = "Clique para reproduzir";
              playerState = 'paused';
              updatePlayButton();
            });
          }
        } else {
          statusDiv.textContent = "Clique para reproduzir";
          playerState = 'paused';
          updatePlayButton();
        }
      };
    }
    
    renderPlaylist();
    
  } catch (error) {
    statusDiv.textContent = "Erro ao reproduzir: " + error.message;
    playerState = 'stopped';
    updatePlayButton();
  }
}

function togglePlay() {
  if (currentTrack === -1) {
    // Se nada estiver selecionado, come√ßar do primeiro item
    if (library.length > 0) playTrack(0);
    return;
  }
  
  if (playerState === 'playing') {
    if (audioPlayer.style.display==="block") {
      audioPlayer.pause();
    } else if (videoPlayer.style.display==="block") {
      videoPlayer.pause();
    }
    playerState = 'paused';
    statusDiv.textContent = "Pausado";
  } else {
    if (audioPlayer.style.display==="block") {
      audioPlayer.play().then(function() {
        playerState = 'playing';
        statusDiv.textContent = "Reproduzindo";
        updatePlayButton();
      }).catch(function(error) {
        statusDiv.textContent = "Erro ao reproduzir: " + error.message;
      });
    } else if (videoPlayer.style.display==="block") {
      videoPlayer.play().then(function() {
        playerState = 'playing';
        statusDiv.textContent = "Reproduzindo";
        updatePlayButton();
      }).catch(function(error) {
        statusDiv.textContent = "Erro ao reproduzir: " + error.message;
      });
    }
  }
  updatePlayButton();
}

function updatePlayButton() {
  playPauseBtn.textContent = playerState === 'playing' ? '‚è∏' : '‚ñ∂Ô∏è';
}

function stopTrack() {
  audioPlayer.pause();
  audioPlayer.currentTime = 0;
  videoPlayer.pause();
  videoPlayer.currentTime = 0;
  playerState = 'stopped';
  statusDiv.textContent = "Parado";
  updatePlayButton();
}

function prevTrack() {
  if (library.length === 0) return;
  
  if (randomMode) {
    playRandomTrack();
    return;
  }
  
  var newIndex = currentTrack > 0 ? currentTrack - 1 : library.length - 1;
  playTrack(newIndex);
}

function nextTrack() {
  if (library.length === 0) return;
  
  if (randomMode) {
    playRandomTrack();
    return;
  }
  
  var newIndex = currentTrack < library.length - 1 ? currentTrack + 1 : 0;
  playTrack(newIndex);
}

function handleMediaEnded() {
  if (randomMode) {
    playRandomTrack();
  } else {
    nextTrack();
  }
}

function playRandomTrack() {
  if (library.length === 0) return;
  
  // Obter faixas filtradas
  var search = document.getElementById("search").value.toLowerCase();
  var filteredTracks = library.filter(function(track) {
    if (filterType!=="all" && track.type!==filterType) return false;
    if (search && !(track.title.toLowerCase().includes(search) || track.artist.toLowerCase().includes(search))) return false;
    return true;
  });
  
  if (filteredTracks.length === 0) return;
  
  // Se s√≥ h√° uma faixa, reproduzir ela
  if (filteredTracks.length === 1) {
    var trackIndex = library.indexOf(filteredTracks[0]);
    playTrack(trackIndex);
    return;
  }
  
  // Garantir que n√£o repita a mesma faixa
  var currentFilteredIndex = filteredTracks.findIndex(track => library.indexOf(track) === currentTrack);
  var randomIndex;
  do {
    randomIndex = Math.floor(Math.random() * filteredTracks.length);
  } while (randomIndex === currentFilteredIndex && filteredTracks.length > 1);
  
  var trackIndex = library.indexOf(filteredTracks[randomIndex]);
  playTrack(trackIndex);
}

function toggleRandom() {
  randomMode = !randomMode;
  randomBtn.classList.toggle('active', randomMode);
  statusDiv.textContent = randomMode ? "Modo aleat√≥rio ativado" : "Modo aleat√≥rio desativado";
}

function setFilter(type) {
  filterType = type;
  document.querySelectorAll("#filters button").forEach(btn=>btn.classList.remove("active"));
  var buttons = document.querySelectorAll("#filters button");
  for (var i = 0; i < buttons.length; i++) {
    if (buttons[i].textContent.toLowerCase().includes(type)) {
      buttons[i].classList.add("active");
      break;
    }
  }
  renderPlaylist();
}

function exitFullscreen() {
  if (document.fullscreenElement) {
    document.exitFullscreen().catch(function(err) {
      console.error("Erro ao sair da tela cheia:", err);
    });
  }
  closeBtn.style.display="none";
}

// Inicializar o player
loadPlaylists();
</script>
</body>
</html>
