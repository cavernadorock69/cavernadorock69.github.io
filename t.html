<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Caverna do Rock 69</title>
<style>
body {
  margin: 0;
  font-family: sans-serif;
  background: #111;
  color: #eee;
}

#header {
  background: #222;
  padding: 10px;
  position: sticky;
  top: 0;
  z-index: 100;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

#controls {
  display: flex;
  gap: 10px;
  align-items: center;
  flex-wrap: wrap;
}

#controls button {
  background: #333;
  border: none;
  color: #eee;
  padding: 6px 10px;
  cursor: pointer;
}
#controls button:hover {
  background: #555;
}

#searchBox {
  padding: 6px;
  font-size: 14px;
  width: 100%;
  box-sizing: border-box;
}

#musicList {
  height: calc(100vh - 120px);
  overflow-y: auto;
  padding: 10px;
}

.track {
  padding: 4px;
  cursor: pointer;
}
.track:hover {
  background: #333;
}
.track.playing {
  background: #555;
}
</style>
</head>
<body>

<div id="header">
  <div id="controls">
    <button onclick="prev()">⏮</button>
    <button onclick="togglePlay()">▶️/⏸</button>
    <button onclick="next()">⏭</button>

    <!-- substituí botões por checkboxes -->
    <label><input type="checkbox" id="chkShuffle"> Aleatório</label>
    <label><input type="radio" name="repeatMode" value="none" checked> Sem repetir</label>
    <label><input type="radio" name="repeatMode" value="one"> Repetir 1</label>
    <label><input type="radio" name="repeatMode" value="all"> Repetir todos</label>

    <span id="nowPlaying">Nenhuma música</span>
  </div>
  <input type="text" id="searchBox" placeholder="Buscar músicas, artistas ou álbuns...">
</div>

<div id="musicList"></div>
<audio id="audio"></audio>

<script>
var playlists = [
  "https://api.github.com/repos/cavernadorock69/cavernadorock69.github.io/contents/minhas_cole%C3%A7%C3%B5es",
  "https://api.github.com/repos/cavernadorock69/cavernadorock69.github.io/contents/outras_cole%C3%A7%C3%B5es"
];

var tracks = [];
var current = -1;
var audio = document.getElementById("audio");

function fetchPlaylists(){
  playlists.forEach(url => {
    fetch(url).then(r => r.json()).then(data => {
      data.filter(f => f.name.endsWith(".m3u")).forEach(f => {
        fetch(f.download_url).then(r=>r.text()).then(txt => {
          var found = parseM3UContent(txt, f.download_url);
          found.forEach(src => addTrack(src));
          renderList();
        });
      });
    });
  });
}

function parseM3UContent(text, baseUrl){
  var lines = text.split(/\r?\n/);
  var found = [];
  for(var i=0;i<lines.length;i++){
    var l = lines[i].trim();
    if(!l) continue;
    if(l.charAt(0)==='#') continue;
    var src = l;
    if(!/^https?:\/\//i.test(l) && baseUrl.indexOf('raw.githubusercontent')>-1){
      var parts = baseUrl.split('/');
      parts.pop();
      src = parts.join('/') + '/' + l;
    }
    found.push(src);
  }
  return found;
}

function addTrack(url){
  var name = decodeURIComponent(url.split("/").pop());
  var artist = "Desconhecido", album = "", title = name;
  var parts = name.split(" - ");
  if(parts.length==3){ artist=parts[0]; album=parts[1]; title=parts[2]; }
  else if(parts.length==2){ artist=parts[0]; title=parts[1]; }
  tracks.push({url:url, artist:artist, album:album, title:title});
}

function renderList(){
  var list = document.getElementById("musicList");
  list.innerHTML="";
  tracks.forEach((t,i)=>{
    var div=document.createElement("div");
    div.className="track";
    div.textContent = (t.artist? t.artist+" - ":"")+ (t.album? t.album+" - ":"")+ t.title;
    div.onclick = ()=>playIndex(i);
    list.appendChild(div);
  });
}

function playIndex(i){
  if(i<0||i>=tracks.length) return;
  current=i;
  audio.src=tracks[i].url;
  audio.play();
  document.getElementById("nowPlaying").textContent = "▶️ "+tracks[i].artist+" - "+(tracks[i].album? tracks[i].album+" - ":"")+tracks[i].title;
  document.querySelectorAll(".track").forEach((el,idx)=>{
    el.classList.toggle("playing", idx===i);
  });
}

function togglePlay(){
  if(audio.paused) audio.play(); else audio.pause();
}
function next(){
  let shuffle = document.getElementById("chkShuffle").checked;
  let repeatMode = document.querySelector("input[name='repeatMode']:checked").value;

  if(shuffle){
    playIndex(Math.floor(Math.random()*tracks.length));
  } else {
    var ni=current+1;
    if(ni>=tracks.length){
      if(repeatMode==="all"){ ni=0; } 
      else { return; }
    }
    playIndex(ni);
  }
}
function prev(){
  var pi=current-1;
  if(pi<0){
    let repeatMode = document.querySelector("input[name='repeatMode']:checked").value;
    if(repeatMode==="all") pi=tracks.length-1; else return;
  }
  playIndex(pi);
}

// comportamento quando a música termina
audio.addEventListener("ended",()=>{
  let repeatMode = document.querySelector("input[name='repeatMode']:checked").value;
  if(repeatMode==="one"){
    playIndex(current); // repete a mesma
  } else {
    next();
  }
});

document.getElementById("searchBox").addEventListener("input", function(){
  var q = this.value.toLowerCase();
  var items = document.querySelectorAll("#musicList .track");
  items.forEach(function(it){
    it.style.display = it.textContent.toLowerCase().includes(q) ? "" : "none";
  });
});

fetchPlaylists();
</script>
</body>
</html>
