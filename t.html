<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Player Retr√¥ Winamp Style</title>
<style>
  body {
    background-color: #111;
    color: #0f0;
    font-family: monospace;
    margin: 0;
    padding: 20px;
  }
  #player-container {
    background: #222;
    border: 2px solid #0f0;
    padding: 10px;
    max-width: 800px;
    margin: auto;
  }
  #controls button {
    background: #333;
    border: 1px solid #0f0;
    color: #0f0;
    padding: 5px 10px;
    margin: 2px;
    cursor: pointer;
  }
  #controls button:hover {
    background: #0f0;
    color: #000;
  }
  #filters button {
    background: #111;
    border: 1px solid #0f0;
    color: #0f0;
    margin: 2px;
    cursor: pointer;
  }
  #filters button.active {
    background: #0f0;
    color: #000;
  }
  #search {
    width: 100%;
    padding: 5px;
    background: #111;
    border: 1px solid #0f0;
    color: #0f0;
    margin-bottom: 10px;
  }
  #playlist {
    max-height: 400px;
    overflow-y: auto;
    background: #000;
    border: 1px solid #0f0;
    padding: 5px;
  }
  .track {
    padding: 4px;
    cursor: pointer;
  }
  .track:hover {
    background: #0f0;
    color: #000;
  }
  .playing {
    background: #060;
  }
  video {
    width: 100%;
    height: auto;
    display: none;
    background: #000;
  }
  audio {
    width: 100%;
  }
  #closeFullscreen {
    display: none;
    position: fixed;
    top: 10px;
    right: 20px;
    background: #f00;
    color: #fff;
    font-weight: bold;
    padding: 5px 10px;
    cursor: pointer;
    z-index: 9999;
  }
</style>
</head>
<body>
<div id="player-container">
  <div id="now-playing">Carregando biblioteca...</div>

  <div id="controls">
    <button onclick="prevTrack()">‚èÆ</button>
    <button onclick="togglePlay()">‚ñ∂Ô∏è/‚è∏</button>
    <button onclick="stopTrack()">‚èπ</button>
    <button onclick="nextTrack()">‚è≠</button>
  </div>

  <div id="filters">
    <button onclick="setFilter('all')" class="active">Todos</button>
    <button onclick="setFilter('mp3')">MP3</button>
    <button onclick="setFilter('wav')">WAV</button>
    <button onclick="setFilter('flac')">FLAC</button>
    <button onclick="setFilter('mp4')">Clips</button>
  </div>

  <input type="text" id="search" placeholder="üîç Buscar m√∫sica/clipe..." oninput="renderPlaylist()">

  <div id="playlist"></div>

  <audio id="audioPlayer" controls></audio>
  <video id="videoPlayer" controls>
    <source id="videoSource" type="video/mp4">
  </video>
</div>

<button id="closeFullscreen" onclick="exitFullscreen()">[X] Fechar</button>

<script>
var repositories = [
  "https://api.github.com/repos/cavernadorock69/cavernadorock69.github.io/contents/minhas_cole%C3%A7%C3%B5es",
  "https://api.github.com/repos/cavernadorock69/cavernadorock69.github.io/contents/outras_cole%C3%A7%C3%B5es",
  "https://api.github.com/repos/cavernadorock69/cavernadorock69.github.io/contents/clips_e_shows"
];

var library = [];
var currentTrack = -1;
var filterType = "all";

var audioPlayer = document.getElementById("audioPlayer");
var videoPlayer = document.getElementById("videoPlayer");
var videoSource = document.getElementById("videoSource");
var closeBtn = document.getElementById("closeFullscreen");
var nowPlaying = document.getElementById("now-playing");
var playlistDiv = document.getElementById("playlist");

function loadPlaylists() {
  var pending = repositories.length;
  repositories.forEach(function(repoUrl){
    var xhr = new XMLHttpRequest();
    xhr.open("GET", repoUrl, true);
    xhr.onreadystatechange = function(){
      if (xhr.readyState === 4) {
        if (xhr.status >=200 && xhr.status < 300) {
          try {
            var files = JSON.parse(xhr.responseText);
            files.forEach(function(f){
              if (f && f.name && f.name.toLowerCase().endsWith(".m3u") && f.download_url) {
                fetchM3u(f.download_url);
              }
            });
          } catch(e){}
        }
        pending--;
        if (pending===0) renderPlaylist();
      }
    };
    xhr.send();
  });
}

function fetchM3u(url) {
  var xhr = new XMLHttpRequest();
  xhr.open("GET", url, true);
  xhr.onreadystatechange = function(){
    if (xhr.readyState === 4 && xhr.status>=200 && xhr.status<300){
      parseM3u(xhr.responseText);
      renderPlaylist();
    }
  };
  xhr.send();
}

function parseM3u(text) {
  var lines = text.split(/\r?\n/);
  var artist="", title="";
  for (var i=0;i<lines.length;i++) {
    var line = lines[i].trim();
    if (!line) continue;
    if (line.startsWith("#EXTINF:")) {
      var info = line.split(",")[1] || "";
      var parts = info.split(" - ");
      artist = parts[0] || "Desconhecido";
      title = parts[1] || info;
    } else if (!line.startsWith("#")) {
      var url = line;
      var ext = url.split("?")[0].split(".").pop().toLowerCase(); // pega extens√£o antes do ?
      library.push({artist:artist, title:title, url:url, type:ext});
      artist=""; title="";
    }
  }
}

function renderPlaylist() {
  playlistDiv.innerHTML = "";
  var search = document.getElementById("search").value.toLowerCase();
  library.forEach(function(track, index){
    if (filterType!=="all" && track.type!==filterType) return;
    if (search && !(track.title.toLowerCase().includes(search) || track.artist.toLowerCase().includes(search))) return;
    var div = document.createElement("div");
    div.className = "track" + (index===currentTrack?" playing":"");
    div.textContent = (index+1)+". "+track.artist+" - "+track.title;
    div.onclick = function(){ playTrack(index); };
    playlistDiv.appendChild(div);
  });
}

function playTrack(index) {
  currentTrack = index;
  var track = library[index];
  nowPlaying.textContent = "Tocando: "+track.artist+" - "+track.title;

  audioPlayer.pause();
  videoPlayer.pause();
  videoPlayer.style.display="none";
  audioPlayer.style.display="none";
  closeBtn.style.display="none";

  if (track.type==="mp4") {
    videoSource.src = track.url;
    videoPlayer.load();
    videoPlayer.style.display="block";
    videoPlayer.play();
    if (videoPlayer.requestFullscreen) videoPlayer.requestFullscreen();
    closeBtn.style.display="block";
  } else {
    audioPlayer.src = track.url;
    audioPlayer.style.display="block";
    audioPlayer.play();
  }
  renderPlaylist();
}

function togglePlay() {
  if (audioPlayer.style.display==="block") {
    if (audioPlayer.paused) audioPlayer.play(); else audioPlayer.pause();
  } else if (videoPlayer.style.display==="block") {
    if (videoPlayer.paused) videoPlayer.play(); else videoPlayer.pause();
  }
}
function stopTrack() {
  audioPlayer.pause(); audioPlayer.currentTime=0;
  videoPlayer.pause(); videoPlayer.currentTime=0;
}
function prevTrack() { if (currentTrack>0) playTrack(currentTrack-1); }
function nextTrack() { if (currentTrack<library.length-1) playTrack(currentTrack+1); }

function setFilter(type) {
  filterType = type;
  document.querySelectorAll("#filters button").forEach(btn=>btn.classList.remove("active"));
  var map = {all:0, mp3:1, wav:2, flac:3, mp4:4};
  document.querySelectorAll("#filters button")[map[type]].classList.add("active");
  renderPlaylist();
}

function exitFullscreen() {
  if (document.fullscreenElement) document.exitFullscreen();
  closeBtn.style.display="none";
}

loadPlaylists();
</script>
</body>
</html>
