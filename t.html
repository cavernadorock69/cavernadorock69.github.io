<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player com Display de Qualidade</title>
    <!-- Biblioteca para ler metadados de áudio -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
    <style>
        /* CSS da versão anterior com a adição da status-bar */
        :root {
            --cor-fundo: #000; --cor-texto-principal: #fff; --cor-texto-display: #0f0;
            --cor-destaque: #008080; --cor-gradiente-inicio: #000080; --cor-gradiente-fim: #1084d0;
            --cor-cinza-claro: #c0c0c0; --cor-cinza-medio: #808080; --cor-cinza-escuro: #404040;
            --cor-borda-clara: #dfdfdf;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Tahoma', 'Arial', sans-serif; font-size: 14px; }
        body {
            background-color: var(--cor-fundo ); color: var(--cor-texto-principal); display: flex;
            justify-content: center; align-items: center; min-height: 100vh; padding: 10px;
        }
        .player-container {
            width: 100%; max-width: 480px; min-width: 320px; background: var(--cor-cinza-claro);
            border: 2px solid; border-color: var(--cor-borda-clara) var(--cor-cinza-escuro) var(--cor-cinza-escuro) var(--cor-borda-clara);
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5); display: flex; flex-direction: column;
        }
        .title-bar {
            background: linear-gradient(to right, var(--cor-gradiente-inicio), var(--cor-gradiente-fim));
            padding: 4px 8px; display: flex; justify-content: space-between; align-items: center;
            cursor: move; color: var(--cor-texto-principal);
        }
        .main-content { padding: 10px; }
        .display-area { display: flex; gap: 10px; margin-bottom: 10px; }
        .album-art {
            width: 60px; height: 60px; border: 2px inset var(--cor-cinza-escuro); background: var(--cor-fundo);
            flex-shrink: 0; display: flex; align-items: center; justify-content: center; overflow: hidden;
        }
        .album-art img { width: 100%; height: 100%; object-fit: cover; }
        .album-art-placeholder { font-size: 10px; color: var(--cor-texto-display); text-align: center; padding: 2px; }
        .info-display {
            flex-grow: 1; height: 60px; background: var(--cor-fundo); color: var(--cor-texto-display);
            padding: 4px 8px; font-family: 'MS Sans Serif', 'Courier New', monospace; overflow: hidden;
            border: 2px inset var(--cor-cinza-escuro); position: relative;
        }
        .track-info-scroller { position: absolute; white-space: nowrap; animation: scroll 20s linear infinite paused; }
        .track-info-scroller.scrolling { animation-play-state: running; }
        @keyframes scroll { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        .progress-container { height: 12px; background: var(--cor-fundo); border: 1px solid var(--cor-cinza-medio); margin-bottom: 10px; cursor: pointer; }
        .progress-bar { height: 100%; width: 0%; background: linear-gradient(to right, var(--cor-gradiente-inicio), var(--cor-gradiente-fim)); }
        .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(40px, 1fr)); gap: 5px; margin-bottom: 10px; }
        .btn {
            padding: 8px 5px; background: var(--cor-cinza-claro); border: 2px outset var(--cor-borda-clara);
            cursor: pointer; font-weight: bold; color: #000; transition: background 0.1s;
        }
        .btn:active { border-style: inset; }
        .btn.active { background: var(--cor-destaque); color: var(--cor-texto-principal); border-style: inset; }
        .filters { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px; }
        .filter-btn { padding: 4px 8px; font-size: 12px; }
        .search-box { width: 100%; padding: 6px; margin-bottom: 10px; border: 2px inset var(--cor-cinza-escuro); background-color: var(--cor-texto-principal); color: #000; }
        
        .library-content { max-height: 250px; overflow-y: auto; border: 1px solid var(--cor-cinza-medio); background: var(--cor-texto-principal); color: #000; }
        .artist-item, .album-item { padding: 6px 8px; cursor: pointer; font-weight: bold; border-bottom: 1px solid #eee; }
        .artist-item { background-color: #e0e0e0; }
        .album-item { background-color: #f0f0f0; padding-left: 20px; }
        .track-item { padding: 5px 8px 5px 35px; border-bottom: 1px solid #f5f5f5; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .artist-item:hover, .album-item:hover { background-color: #ddd; }
        .track-item:hover { background-color: #e8e8e8; }
        .track-item.playing { background: var(--cor-gradiente-inicio); color: var(--cor-texto-principal); font-weight: bold; }
        .album-container, .track-container { display: none; }
        .hidden { display: none; }

        /* --- Barra de Status --- */
        .status-bar {
            background: var(--cor-cinza-claro);
            padding: 3px 8px;
            border-top: 1px solid var(--cor-cinza-medio);
            display: flex;
            justify-content: space-between;
            color: #000;
            font-size: 11px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="player-container">
        <div class="title-bar"><span class="title-text">Web Player M3U</span></div>
        <div class="main-content">
            <div class="display-area">
                <div id="albumArt" class="album-art"><div class="album-art-placeholder">Capa</div></div>
                <div class="info-display"><span id="trackInfoScroller" class="track-info-scroller">Bem-vindo!</span></div>
            </div>
            <div class="progress-container" id="progressContainer"><div class="progress-bar" id="progressBar"></div></div>
            <div class="controls">
                <button class="btn" id="prevBtn" title="Anterior">◀◀</button>
                <button class="btn" id="playPauseBtn" title="Play/Pause">▶</button>
                <button class="btn" id="stopBtn" title="Parar">■</button>
                <button class="btn" id="nextBtn" title="Próxima">▶▶</button>
                <button class="btn" id="shuffleBtn" title="Modo Aleatório">🔀</button>
            </div>
            <div class="filters">
                <button class="btn filter-btn active" data-filter="all">Todos</button>
                <button class="btn filter-btn" data-filter="mp3">MP3</button>
                <button class="btn filter-btn" data-filter="flac">FLAC</button>
                <button class="btn filter-btn" data-filter="wav">WAV</button>
            </div>
            <input type="text" id="searchInput" class="search-box" placeholder="Buscar por Artista, Álbum ou Título...">
            <div class="library-content" id="libraryContent"></div>
        </div>
        <div class="status-bar">
            <span id="bitrateInfo">-- kbps</span>
            <span id="samplerateInfo">-- kHz</span>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const LASTFM_API_KEY = 'SUA_CHAVE_DE_API_AQUI';
        const LASTFM_API_URL = 'https://ws.audioscrobbler.com/2.0/';

        const playPauseBtn = document.getElementById('playPauseBtn' ), stopBtn = document.getElementById('stopBtn'),
              prevBtn = document.getElementById('prevBtn'), nextBtn = document.getElementById('nextBtn'),
              shuffleBtn = document.getElementById('shuffleBtn'), progressContainer = document.getElementById('progressContainer'),
              progressBar = document.getElementById('progressBar'), libraryContent = document.getElementById('libraryContent'),
              trackInfoScroller = document.getElementById('trackInfoScroller'), searchInput = document.getElementById('searchInput'),
              albumArt = document.getElementById('albumArt'), filterButtons = document.querySelectorAll('.filter-btn'),
              bitrateInfo = document.getElementById('bitrateInfo'), samplerateInfo = document.getElementById('samplerateInfo'),
              audioElement = new Audio();

        let flatTracks = [], library = {}, currentTrackIndex = -1, isPlaying = false, isShuffle = false, originalFlatTracks = [], currentFilter = 'all';
        const artCache = new Map();

        const repositories = [
            'https://api.github.com/repos/cavernadorock69/cavernadorock69.github.io/contents/minhas_cole%C3%A7%C3%B5es',
            'https://api.github.com/repos/cavernadorock69/cavernadorock69.github.io/contents/outras_cole%C3%A7%C3%B5es'
        ];

        async function init( ) {
            addEventListeners();
            await loadAndBuildLibrary();
            if (flatTracks.length > 0) {
                originalFlatTracks = [...flatTracks];
                renderLibrary();
                updateTrackInfo('Pronto para tocar. Selecione uma música.');
            } else {
                updateTrackInfo('Nenhuma música encontrada.');
            }
        }

        async function loadAndBuildLibrary() {
            // ... (código de carregamento da biblioteca, igual ao anterior)
            updateTrackInfo('Buscando playlists...');
            const m3uUrls = [];
            for (const repoUrl of repositories) {
                try {
                    const response = await fetch(repoUrl);
                    const files = await response.json();
                    files.filter(file => file.name.endsWith('.m3u')).forEach(file => m3uUrls.push(file.download_url));
                } catch (error) { console.error(`Erro ao buscar no repositório ${repoUrl}:`, error); }
            }

            if (m3uUrls.length === 0) return;
            updateTrackInfo(`Carregando ${m3uUrls.length} playlists...`);

            const m3uContents = await Promise.all(m3uUrls.map(url => fetch(url).then(res => res.text())));
            
            let tempTracks = [];
            m3uContents.forEach(content => {
                let currentArtist = "Artista Desconhecido", currentAlbum = "Álbum Desconhecido", currentArtwork = "";
                const lines = content.split('\n').map(l => l.trim()).filter(l => l);

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    if (line.startsWith('#EXTART:')) currentArtist = line.substring(8);
                    if (line.startsWith('#EXTALB:')) currentAlbum = line.substring(8);
                    if (line.startsWith('#EXTIMG:')) currentArtwork = line.substring(8);
                    
                    if (line.startsWith('#EXTINF:')) {
                        const title = line.split(',').slice(1).join(',');
                        const urlLine = lines[i + 1];
                        
                        if (urlLine && !urlLine.startsWith('#')) {
                            const format = urlLine.split('.').pop().toLowerCase();
                            const existingTrack = tempTracks.find(t => t.title === title && t.artist === currentArtist && t.album === currentAlbum);

                            if (existingTrack) {
                                existingTrack.sources[format] = urlLine;
                            } else {
                                const yearMatch = currentAlbum.match(/\b(\d{4})\b/);
                                tempTracks.push({
                                    title: title, artist: currentArtist, album: currentAlbum,
                                    artwork: currentArtwork, year: yearMatch ? yearMatch[1] : '0000',
                                    sources: { [format]: urlLine }
                                });
                            }
                            i++;
                        }
                    }
                }
            });

            library = {};
            tempTracks.forEach(track => {
                if (!library[track.artist]) library[track.artist] = {};
                if (!library[track.artist][track.album]) {
                    library[track.artist][track.album] = { year: track.year, artwork: track.artwork, tracks: [] };
                }
                library[track.artist][track.album].tracks.push(track);
            });

            const sortedArtists = Object.keys(library).sort((a, b) => a.localeCompare(b));
            const sortedLibrary = {};
            sortedArtists.forEach(artist => {
                const albums = library[artist];
                const sortedAlbums = Object.keys(albums).sort((a, b) => albums[a].year.localeCompare(albums[b].year));
                sortedLibrary[artist] = {};
                sortedAlbums.forEach(album => {
                    sortedLibrary[artist][album] = albums[album];
                });
            });
            library = sortedLibrary;

            flatTracks = [];
            Object.values(library).forEach(albums => {
                Object.values(albums).forEach(albumData => {
                    flatTracks.push(...albumData.tracks);
                });
            });
        }

        function playTrack(index) {
            if (index < 0 || index >= flatTracks.length) return;
            currentTrackIndex = index;
            const track = flatTracks[currentTrackIndex];

            const preferredOrder = [currentFilter, 'flac', 'mp3', 'wav', 'all'];
            let urlToPlay = null;
            let formatToPlay = '';
            for (const format of preferredOrder) {
                if (track.sources[format]) {
                    urlToPlay = track.sources[format];
                    formatToPlay = format;
                    break;
                }
            }
            if (!urlToPlay) {
                formatToPlay = Object.keys(track.sources)[0];
                urlToPlay = track.sources[formatToPlay];
            }

            if (!urlToPlay) {
                updateTrackInfo(`Nenhuma fonte de áudio para: ${track.title}`);
                return;
            }

            audioElement.src = urlToPlay;
            audioElement.play().catch(e => console.error("Erro ao tocar:", e));

            updateTrackInfo(`Tocando: ${track.artist} - ${track.title}`);
            playPauseBtn.textContent = '❚❚';
            isPlaying = true;
            highlightCurrentTrack();
            fetchAndSetAlbumArt(track);
            updateStatusInfo(urlToPlay, formatToPlay); // <-- ATUALIZA AS INFORMAÇÕES DE STATUS
        }

        function updateStatusInfo(url, format) {
            // Reseta as informações
            bitrateInfo.textContent = `${format.toUpperCase()}`;
            samplerateInfo.textContent = '-- kHz';

            // Usa jsmediatags para ler os metadados
            window.jsmediatags.read(url, {
                onSuccess: function(tag) {
                    const header = tag.tags.v2 || tag.tags.v1;
                    if (header && header.header) {
                        const bitrate = header.header.bitrate;
                        const sampleRate = header.header.sampleRate;
                        if (bitrate) {
                            bitrateInfo.textContent = `${format.toUpperCase()} ${bitrate} kbps`;
                        }
                        if (sampleRate) {
                            samplerateInfo.textContent = `${(sampleRate / 1000).toFixed(1)} kHz`;
                        }
                    }
                },
                onError: function(error) {
                    console.log('jsmediatags: Não foi possível ler as tags.', error.type, error.info);
                    // Para FLAC e outros, exibe apenas o formato, pois a leitura de tags é limitada
                    bitrateInfo.textContent = `${format.toUpperCase()}`;
                }
            });
        }
        
        // --- Restante do código (renderLibrary, handleSearch, event listeners, etc.) ---
        // ... (todo o resto do JS é igual à versão anterior)
        function renderLibrary() {
            libraryContent.innerHTML = '';
            Object.keys(library).forEach(artistName => {
                const artistData = library[artistName];
                const artistItem = document.createElement('div');
                artistItem.className = 'artist-item';
                artistItem.textContent = artistName;
                artistItem.dataset.artist = artistName;
                libraryContent.appendChild(artistItem);

                const albumContainer = document.createElement('div');
                albumContainer.className = 'album-container';
                artistItem.after(albumContainer);

                Object.keys(artistData).forEach(albumName => {
                    const albumData = artistData[albumName];
                    const albumItem = document.createElement('div');
                    albumItem.className = 'album-item';
                    albumItem.textContent = albumName;
                    albumItem.dataset.album = albumName;
                    albumContainer.appendChild(albumItem);

                    const trackContainer = document.createElement('div');
                    trackContainer.className = 'track-container';
                    albumItem.after(trackContainer);

                    albumData.tracks.forEach(track => {
                        const trackIndex = flatTracks.findIndex(t => t === track);
                        const trackItem = document.createElement('div');
                        trackItem.className = 'track-item';
                        trackItem.textContent = track.title;
                        trackItem.dataset.index = trackIndex;
                        trackContainer.appendChild(trackItem);
                    });
                });
            });
        }
        function handleSearch() {
            const query = searchInput.value.toLowerCase();
            if (query === "") {
                document.querySelectorAll('.artist-item, .album-item, .track-item').forEach(el => el.classList.remove('hidden'));
                document.querySelectorAll('.album-container, .track-container').forEach(el => el.style.display = 'none');
                return;
            }
            Object.keys(library).forEach(artistName => {
                const artistMatch = artistName.toLowerCase().includes(query);
                const artistItem = document.querySelector(`.artist-item[data-artist="${artistName}"]`);
                let artistVisible = false;
                Object.keys(library[artistName]).forEach(albumName => {
                    const albumMatch = albumName.toLowerCase().includes(query);
                    const albumItem = document.querySelector(`.album-item[data-album="${albumName}"]`);
                    const trackContainer = albumItem.nextElementSibling;
                    let albumVisible = false;
                    library[artistName][albumName].tracks.forEach(track => {
                        const trackMatch = track.title.toLowerCase().includes(query);
                        const trackIndex = flatTracks.findIndex(t => t === track);
                        const trackItem = document.querySelector(`.track-item[data-index="${trackIndex}"]`);
                        const isVisible = artistMatch || albumMatch || trackMatch;
                        trackItem.classList.toggle('hidden', !isVisible);
                        if (isVisible) albumVisible = true;
                    });
                    albumItem.classList.toggle('hidden', !albumVisible);
                    trackContainer.style.display = albumVisible ? 'block' : 'none';
                    if (albumVisible) artistVisible = true;
                });
                artistItem.classList.toggle('hidden', !artistVisible);
                artistItem.nextElementSibling.style.display = artistVisible ? 'block' : 'none';
            });
        }
        function addEventListeners() {
            searchInput.addEventListener('input', handleSearch);
            libraryContent.addEventListener('click', e => {
                const target = e.target;
                if (target.matches('.artist-item')) target.nextElementSibling.style.display = target.nextElementSibling.style.display === 'block' ? 'none' : 'block';
                if (target.matches('.album-item')) target.nextElementSibling.style.display = target.nextElementSibling.style.display === 'block' ? 'none' : 'block';
                if (target.matches('.track-item')) playTrack(parseInt(target.dataset.index));
            });
            playPauseBtn.addEventListener('click', () => {
                if (!audioElement.src && flatTracks.length > 0) { playTrack(0); return; }
                if (isPlaying) { audioElement.pause(); playPauseBtn.textContent = '▶'; } 
                else { audioElement.play(); playPauseBtn.textContent = '❚❚'; }
                isPlaying = !isPlaying;
            });
            stopBtn.addEventListener('click', () => {
                audioElement.pause(); audioElement.currentTime = 0; playPauseBtn.textContent = '▶'; isPlaying = false;
                updateTrackInfo('Parado.'); albumArt.innerHTML = '<div class="album-art-placeholder">Capa</div>'; progressBar.style.width = '0%';
                bitrateInfo.textContent = '-- kbps'; samplerateInfo.textContent = '-- kHz';
            });
            nextBtn.addEventListener('click', () => playTrack((currentTrackIndex + 1) % flatTracks.length));
            prevBtn.addEventListener('click', () => playTrack((currentTrackIndex - 1 + flatTracks.length) % flatTracks.length));
            shuffleBtn.addEventListener('click', () => {
                isShuffle = !isShuffle; shuffleBtn.classList.toggle('active', isShuffle);
                const currentTrack = isShuffle && currentTrackIndex > -1 ? flatTracks[currentTrackIndex] : null;
                flatTracks = isShuffle ? [...originalFlatTracks].sort(() => Math.random() - 0.5) : [...originalFlatTracks];
                if (currentTrack) currentTrackIndex = flatTracks.findIndex(t => t === currentTrack);
                renderLibrary();
                if (currentTrackIndex > -1) highlightCurrentTrack();
            });
            filterButtons.forEach(button => {
                button.addEventListener('click', () => {
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    currentFilter = button.dataset.filter;
                    if (isPlaying) playTrack(currentTrackIndex);
                });
            });
            audioElement.addEventListener('ended', () => playTrack((currentTrackIndex + 1) % flatTracks.length));
            audioElement.addEventListener('timeupdate', () => { progressBar.style.width = `${(audioElement.currentTime / audioElement.duration) * 100 || 0}%`; });
            progressContainer.addEventListener('click', e => {
                if (audioElement.duration) audioElement.currentTime = ((e.clientX - progressContainer.getBoundingClientRect().left) / progressContainer.clientWidth) * audioElement.duration;
            });
        }
        function highlightCurrentTrack() {
            document.querySelectorAll('.track-item').forEach(item => {
                item.classList.remove('playing');
                if (parseInt(item.dataset.index) === currentTrackIndex) {
                    item.classList.add('playing');
                    const trackContainer = item.parentElement;
                    const albumItem = trackContainer.previousElementSibling;
                    const albumContainer = albumItem.parentElement;
                    trackContainer.style.display = 'block';
                    albumContainer.style.display = 'block';
                }
            });
        }
        function updateTrackInfo(text) {
            const scroller = trackInfoScroller;
            scroller.textContent = text;
            scroller.classList.toggle('scrolling', scroller.clientWidth > scroller.parentElement.clientWidth);
        }
        async function fetchAndSetAlbumArt(track) {
            if (track.artwork) { albumArt.innerHTML = `<img src="${track.artwork}" alt="${track.album}">`; return; }
            const cacheKey = `${track.artist}|${track.album}`.toLowerCase();
            if (artCache.has(cacheKey)) {
                const cachedArt = artCache.get(cacheKey);
                if (cachedArt !== 'not_found') albumArt.innerHTML = `<img src="${cachedArt}" alt="${track.album}">`;
                else albumArt.innerHTML = '<div class="album-art-placeholder">Capa N/D</div>';
                return;
            }
            if (!LASTFM_API_KEY || LASTFM_API_KEY === 'SUA_CHAVE_DE_API_AQUI') { albumArt.innerHTML = '<div class="album-art-placeholder">Capa N/D</div>'; return; }
            albumArt.innerHTML = '<div class="album-art-placeholder">Buscando...</div>';
            const url = `${LASTFM_API_URL}?method=album.getinfo&api_key=${LASTFM_API_KEY}&artist=${encodeURIComponent(track.artist)}&album=${encodeURIComponent(track.album)}&format=json`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                const imageUrl = data?.album?.image?.find(img => img.size === 'extralarge')?.['#text'];
                if (imageUrl) {
                    albumArt.innerHTML = `<img src="${imageUrl}" alt="${track.album}">`;
                    artCache.set(cacheKey, imageUrl);
                } else {
                    albumArt.innerHTML = '<div class="album-art-placeholder">Capa N/D</div>';
                    artCache.set(cacheKey, 'not_found');
                }
            } catch (error) {
                console.error("Erro na API Last.fm:", error);
                albumArt.innerHTML = '<div class="album-art-placeholder">Erro API</div>';
                artCache.set(cacheKey, 'not_found');
            }
        }

        init();
    });
    </script>
</body>
</html>
