<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Caverna do Rock Player - Enhanced Edition</title>
<style>
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body { 
  margin: 0; 
  padding: 20px;
  font-family: "Segoe UI", "Arial", "MS Sans Serif", sans-serif; 
  background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #0a0a0a 100%);
  color: #ffffff; 
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  position: relative;
  overflow: auto;
}

.album-background {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  opacity: 0.08;
  z-index: -1;
  filter: blur(2px);
  transition: opacity 0.5s ease;
}

.winamp-container {
  width: min(1000px, 95vw);
  max-height: 95vh;
  display: flex;
  flex-direction: column;
  gap: 15px;
  z-index: 1;
}

.winamp-window {
  width: 100%;
  background: linear-gradient(145deg, #1a1a1a, #0d0d0d);
  border: 2px solid #333;
  border-radius: 12px;
  box-shadow: 
    0 8px 32px rgba(0, 0, 0, 0.6),
    0 0 0 1px rgba(255, 255, 255, 0.1),
    inset 0 1px 0 rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
  overflow: hidden;
}

.winamp-titlebar {
  background: linear-gradient(90deg, #1a1a1a, #2a2a2a, #1a1a1a);
  color: #ffcc00;
  padding: 12px 16px;
  font-size: clamp(16px, 3vw, 22px);
  font-weight: bold;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid #333;
  text-transform: uppercase;
  position: relative;
}

.winamp-titlebar::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, #ffcc00, transparent);
  opacity: 0.5;
}

.titlebar-text { 
  flex-grow: 1; 
  text-align: center; 
  font-weight: bold;
  text-shadow: 0 0 10px rgba(255, 204, 0, 0.5);
}

.titlebar-buttons { 
  display: flex; 
  gap: 4px;
}

.titlebar-button {
  width: clamp(24px, 4vw, 30px);
  height: clamp(20px, 4vw, 24px);
  font-size: clamp(12px, 2.5vw, 16px);
  text-align: center;
  line-height: clamp(20px, 4vw, 24px);
  background: linear-gradient(145deg, #404040, #2a2a2a);
  color: #ffffff;
  border: 1px solid #555;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.titlebar-button:hover {
  background: linear-gradient(145deg, #505050, #3a3a3a);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

.winamp-content { 
  padding: 16px; 
  background: transparent;
}

.header { 
  padding: 12px;
  background: linear-gradient(145deg, #1a1a1a, #0f0f0f);
  display: flex; 
  justify-content: space-between; 
  align-items: center;
  border: 1px solid #333;
  border-radius: 8px;
  margin-bottom: 15px;
  flex-wrap: wrap;
  gap: 10px;
  box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.1);
}

.logo-container {
  display: flex;
  align-items: center;
  gap: 12px;
}

.logo {
  height: 45px;
  width: auto;
  border-radius: 6px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

.header h1 { 
  font-size: clamp(18px, 4vw, 24px); 
  font-weight: bold; 
  margin: 0; 
  color: #ffcc00; 
  text-transform: uppercase;
  text-shadow: 0 0 10px rgba(255, 204, 0, 0.3);
}

.search-box { 
  flex-grow: 1; 
  min-width: 140px;
}

.search-box input { 
  padding: 8px 12px;
  border: 1px solid #444; 
  border-radius: 6px;
  background: linear-gradient(145deg, #0a0a0a, #1a1a1a);
  color: #ffffff; 
  width: 100%;
  font-size: clamp(12px, 2.5vw, 16px);
  transition: all 0.3s ease;
  box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
}

.search-box input:focus {
  outline: none;
  border-color: #ffcc00;
  box-shadow: 
    inset 0 2px 4px rgba(0, 0, 0, 0.3),
    0 0 0 2px rgba(255, 204, 0, 0.2);
}

.main { 
  display: flex; 
  flex-direction: row;
  gap: 15px; 
  align-items: flex-start;
}

.playlist-container {
  flex: 1;
  display: flex;
  flex-direction: column;
  border: 1px solid #333;
  border-radius: 8px;
  background: linear-gradient(145deg, #1a1a1a, #0f0f0f);
  overflow: hidden;
  box-shadow: 
    0 4px 16px rgba(0, 0, 0, 0.4),
    inset 0 1px 0 rgba(255, 255, 255, 0.1);
}

.sidebar { 
  height: 45vh;
  background: transparent;
  padding: 10px;
  overflow-y: auto; 
  font-size: clamp(12px, 2.5vw, 16px);
  color: #ffffff;
}

.player { 
  flex: 1;
  min-width: 300px;
  background: linear-gradient(145deg, #1a1a1a, #0f0f0f);
  padding: 16px;
  display: flex; 
  flex-direction: column; 
  align-items: center; 
  border: 1px solid #333;
  border-radius: 8px;
  position: relative;
  box-shadow: 
    0 4px 16px rgba(0, 0, 0, 0.4),
    inset 0 1px 0 rgba(255, 255, 255, 0.1);
}

.artist-title { 
  font-weight: bold; 
  margin-top: 12px;
  font-size: clamp(14px, 3vw, 18px);
  color: #ffcc00; 
  background: linear-gradient(145deg, #2a2a2a, #1a1a1a);
  padding: 6px 12px;
  text-align: left;
  width: 100%;
  border-radius: 6px;
  border: 1px solid #333;
  text-shadow: 0 0 8px rgba(255, 204, 0, 0.3);
}

.album-title { 
  margin-left: 0;
  font-style: italic; 
  color: #00ccff; 
  margin-top: 8px;
  font-size: clamp(12px, 2.5vw, 16px);
  text-align: left;
  width: 100%;
  padding: 4px 8px;
  background: linear-gradient(145deg, #1a1a1a, #0f0f0f);
  border-radius: 4px;
  border-left: 3px solid #00ccff;
}

.album-artist-name {
  color: #cccccc;
  font-style: normal;
  font-size: 0.9em;
}

.track-item { 
  padding: 8px 12px;
  cursor: pointer; 
  border-bottom: 1px solid #2a2a2a; 
  font-size: clamp(12px, 2.5vw, 16px);
  color: #ffffff; 
  text-align: left;
  width: 100%;
  transition: all 0.2s ease;
  border-radius: 4px;
  margin-bottom: 2px;
}

.track-item:hover { 
  background: linear-gradient(145deg, #333333, #2a2a2a);
  color: #ffcc00;
  transform: translateX(4px);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

.track-item.playing { 
  background: linear-gradient(145deg, #003366, #001a33);
  color: #ffcc00;
  font-weight: bold;
  border-left: 4px solid #ffcc00;
  box-shadow: 
    0 2px 8px rgba(0, 0, 0, 0.3),
    inset 0 1px 0 rgba(255, 204, 0, 0.2);
}

.cover-art-container {
  width: 100%;
  display: flex;
  justify-content: center;
  margin-bottom: 16px;
}

.cover-art { 
  width: 200px;
  height: 200px;
  object-fit: cover;
  border: 2px solid #333;
  border-radius: 12px;
  display: none;
  box-shadow: 
    0 8px 24px rgba(0, 0, 0, 0.5),
    0 0 0 1px rgba(255, 255, 255, 0.1);
  transition: all 0.3s ease;
}

.cover-art:hover {
  transform: scale(1.02);
  box-shadow: 
    0 12px 32px rgba(0, 0, 0, 0.6),
    0 0 0 1px rgba(255, 255, 255, 0.2);
}

.player-controls { 
  display: flex; 
  margin-bottom: 16px;
  align-items: center; 
  flex-wrap: wrap;
  justify-content: center;
  gap: 8px;
  width: 100%;
}

.winamp-button {
  width: clamp(40px, 8vw, 48px);
  height: clamp(40px, 8vw, 48px);
  background: linear-gradient(145deg, #333333, #1a1a1a);
  color: #ffffff;
  border: 1px solid #555;
  border-radius: 8px;
  cursor: pointer;
  font-size: clamp(16px, 3vw, 20px);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0;
  transition: all 0.2s ease;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

.winamp-button:hover { 
  background: linear-gradient(145deg, #444444, #2a2a2a);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
}

.winamp-button:active { 
  background: linear-gradient(145deg, #222222, #111111);
  transform: translateY(0);
  box-shadow: 0 1px 4px rgba(0, 0, 0, 0.4);
}

.winamp-button.toggled { 
  background: linear-gradient(145deg, #003366, #001a33);
  color: #ffcc00;
  box-shadow: 
    0 2px 8px rgba(0, 0, 0, 0.3),
    inset 0 1px 0 rgba(255, 204, 0, 0.2);
}

#volumeControl { 
  width: min(140px, 25vw);
  height: 24px;
  -webkit-appearance: none; 
  background: linear-gradient(145deg, #333333, #1a1a1a);
  border: 1px solid #555;
  border-radius: 12px;
  margin-left: 10px;
  cursor: pointer;
  box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
}

#volumeControl::-webkit-slider-thumb { 
  -webkit-appearance: none; 
  width: 20px;
  height: 20px;
  background: linear-gradient(145deg, #ffcc00, #e6b800);
  border: 1px solid #333;
  border-radius: 50%;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
}

.progress-container {
  width: 100%;
  margin: 12px 0;
  display: flex;
  align-items: center;
  gap: 12px;
}

#progressBar {
  flex-grow: 1;
  height: 20px;
  -webkit-appearance: none;
  background: linear-gradient(145deg, #333333, #1a1a1a);
  border: 1px solid #555;
  border-radius: 10px;
  cursor: pointer;
  box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
}

#progressBar::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 16px;
  height: 16px;
  background: linear-gradient(145deg, #ffcc00, #e6b800);
  border: 1px solid #333;
  border-radius: 50%;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
}

#progressBar::-webkit-slider-runnable-track {
  height: 20px;
  background: linear-gradient(145deg, #222222, #111111);
  border: none;
  border-radius: 10px;
}

.time-display {
  font-size: clamp(12px, 2.5vw, 14px);
  color: #ffcc00;
  min-width: 110px;
  text-align: center;
  background: linear-gradient(145deg, #2a2a2a, #1a1a1a);
  padding: 4px 8px;
  border-radius: 6px;
  border: 1px solid #333;
  font-family: 'Courier New', monospace;
  text-shadow: 0 0 6px rgba(255, 204, 0, 0.3);
}

#track-info { 
  margin-top: 12px;
  font-weight: bold; 
  text-align: center; 
  font-size: clamp(12px, 2.5vw, 16px);
  background: linear-gradient(145deg, #2a2a2a, #1a1a1a);
  padding: 8px 12px;
  border: 1px solid #333;
  border-radius: 8px;
  width: 100%; 
  color: #ffcc00; 
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  text-shadow: 0 0 8px rgba(255, 204, 0, 0.3);
  box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.1);
}

#startIcon { 
  position: absolute; 
  top: 50%; 
  left: 50%; 
  transform: translate(-50%, -50%); 
  font-size: clamp(3rem, 10vw, 5rem);
  cursor: pointer; 
  color: #ffcc00; 
  z-index: 1000; 
  text-shadow: 
    0 0 20px rgba(255, 204, 0, 0.8),
    2px 2px 4px rgba(0, 0, 0, 0.8);
  transition: all 0.3s ease;
}

#startIcon:hover {
  transform: translate(-50%, -50%) scale(1.1);
  text-shadow: 
    0 0 30px rgba(255, 204, 0, 1),
    2px 2px 6px rgba(0, 0, 0, 0.9);
}

.format-filters { 
  display: flex; 
  padding: 10px;
  background: linear-gradient(145deg, #1a1a1a, #0f0f0f);
  border-bottom: 1px solid #333;
  flex-wrap: wrap;
  gap: 6px;
}

.format-button { 
  padding: 6px 12px;
  background: linear-gradient(145deg, #333333, #1a1a1a);
  color: #ffffff; 
  border: 1px solid #555;
  border-radius: 6px;
  font-size: clamp(11px, 2vw, 14px);
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
}

.format-button:hover {
  background: linear-gradient(145deg, #444444, #2a2a2a);
  transform: translateY(-1px);
}

.format-button.active { 
  background: linear-gradient(145deg, #003366, #001a33);
  color: #ffcc00;
  box-shadow: 
    0 2px 6px rgba(0, 0, 0, 0.3),
    inset 0 1px 0 rgba(255, 204, 0, 0.2);
}

#audio-player { 
  display: none; 
}

.sidebar::-webkit-scrollbar { 
  width: 14px; 
}

.sidebar::-webkit-scrollbar-track { 
  background: linear-gradient(145deg, #222222, #111111);
  border-left: 1px solid #333;
  border-radius: 7px;
}

.sidebar::-webkit-scrollbar-thumb { 
  background: linear-gradient(145deg, #444444, #333333);
  border: 1px solid #222222;
  border-radius: 7px;
}

.sidebar::-webkit-scrollbar-thumb:hover { 
  background: linear-gradient(145deg, #555555, #444444);
}

.loading {
  padding: 12px;
  text-align: center;
  color: #ffcc00;
  font-style: italic;
}

.error {
  padding: 12px;
  text-align: center;
  color: #ff6666;
  background: linear-gradient(145deg, #331111, #220808);
  border: 1px solid #553333;
  border-radius: 6px;
  margin: 8px;
}

.simple-mode .album-title,
.simple-mode .album-artist-name {
  display: none;
}

.simple-mode .track-item {
  padding-left: 8px;
}

.status-indicator {
  position: fixed;
  top: 10px;
  right: 10px;
  background: linear-gradient(145deg, #2a2a2a, #1a1a1a);
  color: #ffcc00;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 12px;
  border: 1px solid #333;
  z-index: 1000;
}

/* Animações suaves */
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

.track-item.playing {
  animation: pulse 2s infinite;
}

@keyframes glow {
  0%, 100% { box-shadow: 0 0 5px rgba(255, 204, 0, 0.3); }
  50% { box-shadow: 0 0 20px rgba(255, 204, 0, 0.6); }
}

.winamp-button.toggled {
  animation: glow 3s infinite;
}

/* Media queries responsivas */
@media (max-width: 768px) {
  .main {
    flex-direction: column;
  }
  
  .playlist-container, .player {
    width: 100%;
  }
  
  .sidebar {
    height: 35vh;
  }
  
  .header {
    flex-direction: column;
    align-items: stretch;
  }
  
  .logo-container {
    justify-content: center;
    margin-bottom: 8px;
  }
  
  .search-box {
    min-width: 100%;
  }
  
  .progress-container {
    flex-direction: column;
    gap: 8px;
  }
  
  .time-display {
    width: 100%;
    text-align: center;
  }
  
  .cover-art {
    width: 160px;
    height: 160px;
  }
}

@media (max-width: 480px) {
  body {
    padding: 10px;
  }
  
  .winamp-container {
    max-height: none;
  }
  
  .winamp-content {
    padding: 12px;
  }
  
  .sidebar {
    height: 30vh;
    font-size: 14px;
  }
  
  .player-controls {
    gap: 6px;
  }
  
  .winamp-button {
    width: 40px;
    height: 40px;
    font-size: 16px;
  }
  
  .cover-art {
    width: 140px;
    height: 140px;
  }
}
</style>
</head>
<body>

<div class="album-background"></div>
<div class="status-indicator" id="statusIndicator">Inicializando...</div>
<div class="winamp-container">
  <div class="winamp-window">
    <div class="winamp-titlebar">
      <div class="titlebar-buttons">
        <div class="titlebar-button">—</div>
        <div class="titlebar-button">□</div>
        <div class="titlebar-button">×</div>
      </div>
      <div class="titlebar-text">Caverna do Rock Player</div>
      <div class="titlebar-buttons">
        <div class="titlebar-button">—</div>
      </div>
    </div>
    <div class="winamp-content">
      <div class="header">
        <div class="logo-container">
          <img src="https://github.com/cavernadorock69/cavernadorock69.github.io/blob/main/logo_caverna_do_rock_69.png?raw=true" alt="Caverna do Rock" class="logo" onerror="this.style.display='none'">
          <h1>Caverna do Rock</h1>
        </div>
        <div class="search-box">
          <input type="text" id="searchInput" placeholder="Buscar por música, artista ou álbum...">
        </div>
      </div>
      <div class="main">
        <div class="playlist-container">
          <div class="format-filters" id="formatFilters"></div>
          <div class="sidebar" id="sidebar">
            <div id="results" class="loading">Carregando...</div>
          </div>
        </div>
        <div class="player">
          <div id="startIcon">▶</div>
          <div class="cover-art-container">
            <img id="cover-art" class="cover-art" onerror="this.style.display='none'">
          </div>
          <div class="player-controls">
            <button class="winamp-button" id="prevBtn">⏮</button>
            <button class="winamp-button" id="playPauseBtn">▶</button>
            <button class="winamp-button" id="stopBtn">⏹</button>
            <button class="winamp-button" id="nextBtn">⏭</button>
            <button class="winamp-button" id="shuffleBtn">🔀</button>
            <button class="winamp-button" id="repeatBtn">🔁</button>
            <input type="range" id="volumeControl" min="0" max="1" step="0.01" value="0.5">
          </div>
          <div class="progress-container">
            <input type="range" id="progressBar" min="0" max="100" value="0" step="0.1">
            <div class="time-display" id="timeDisplay">00:00 / 00:00</div>
          </div>
          <audio id="audio-player"></audio>
          <div id="track-info"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Configurações
var ALLOWED_EXT = ['mp3','wav','ogg','flac','mp4'];
var IMAGE_EXT = ['jpg','jpeg','png','gif'];
var tracks = [], allTracks = [], currentTrack = 0, currentFormat = 'mp3';
var shuffle = false, repeat = false;
var isSeeking = false;
var minhaColecao = [], outrosUsuarios = [];
var isSimpleMode = false;

// Variáveis para controle de background
var wakeLock = null;
var audioContext = null;
var isPageVisible = true;
var backgroundPlaybackEnabled = true;

// Elementos do DOM
var audioPlayer = document.getElementById('audio-player');
var resultsContainer = document.getElementById('results');
var trackInfo = document.getElementById('track-info');
var coverArt = document.getElementById('cover-art');
var playPauseBtn = document.getElementById('playPauseBtn');
var volumeControl = document.getElementById('volumeControl');
var formatFilters = document.getElementById('formatFilters');
var searchInput = document.getElementById('searchInput');
var startIcon = document.getElementById('startIcon');
var prevBtn = document.getElementById('prevBtn');
var stopBtn = document.getElementById('stopBtn');
var nextBtn = document.getElementById('nextBtn');
var shuffleBtn = document.getElementById('shuffleBtn');
var repeatBtn = document.getElementById('repeatBtn');
var progressBar = document.getElementById('progressBar');
var timeDisplay = document.getElementById('timeDisplay');
var statusIndicator = document.getElementById('statusIndicator');

// Estrutura de dados
var albumsData = {};

// Função para atualizar status
function updateStatus(message) {
  statusIndicator.textContent = message;
  console.log('Status:', message);
}

// Inicializar Web Audio Context para evitar restrições
function initializeAudioContext() {
  try {
    window.AudioContext = window.AudioContext || window.webkitAudioContext;
    audioContext = new AudioContext();
    updateStatus('Audio Context ativo');
    return true;
  } catch (e) {
    console.warn('Web Audio API não suportada:', e);
    updateStatus('Audio Context não disponível');
    return false;
  }
}

// Função para manter o áudio ativo em background
function enableBackgroundPlayback() {
  // Prevenir que o navegador pause o áudio em background
  audioPlayer.addEventListener('pause', function(e) {
    if (backgroundPlaybackEnabled && !audioPlayer.ended && audioPlayer.currentTime > 0) {
      setTimeout(function() {
        if (!audioPlayer.paused) return;
        audioPlayer.play().catch(function(error) {
          console.log('Erro ao retomar reprodução:', error);
        });
      }, 100);
    }
  });

  // Manter conexão ativa com Web Audio API
  if (audioContext) {
    var source = audioContext.createMediaElementSource(audioPlayer);
    var gainNode = audioContext.createGain();
    source.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    // Manter o contexto ativo
    setInterval(function() {
      if (audioContext.state === 'suspended') {
        audioContext.resume();
      }
    }, 1000);
  }
}

// Função para solicitar Wake Lock (manter tela ativa)
async function requestWakeLock() {
  try {
    if ('wakeLock' in navigator) {
      wakeLock = await navigator.wakeLock.request('screen');
      updateStatus('Wake Lock ativo');
      
      wakeLock.addEventListener('release', function() {
        updateStatus('Wake Lock liberado');
      });
    }
  } catch (err) {
    console.warn('Wake Lock não suportado:', err);
    updateStatus('Wake Lock não disponível');
  }
}

// Função para liberar Wake Lock
function releaseWakeLock() {
  if (wakeLock) {
    wakeLock.release();
    wakeLock = null;
  }
}

// Monitorar visibilidade da página
function setupPageVisibilityAPI() {
  document.addEventListener('visibilitychange', function() {
    isPageVisible = !document.hidden;
    
    if (isPageVisible) {
      updateStatus('Página visível');
      // Retomar contexto de áudio se necessário
      if (audioContext && audioContext.state === 'suspended') {
        audioContext.resume();
      }
    } else {
      updateStatus('Página em background');
      // Manter reprodução ativa mesmo em background
      if (!audioPlayer.paused) {
        // Força a continuação da reprodução
        setTimeout(function() {
          if (!audioPlayer.paused && audioPlayer.currentTime > 0) {
            audioPlayer.play().catch(function(e) {
              console.log('Erro ao manter reprodução em background:', e);
            });
          }
        }, 500);
      }
    }
  });
}

// Função para manter atividade em background
function keepAliveInBackground() {
  // Enviar ping periódico para manter conexão ativa
  setInterval(function() {
    if (!isPageVisible && !audioPlayer.paused) {
      // Simular atividade para evitar throttling
      var xhr = new XMLHttpRequest();
      xhr.open('HEAD', window.location.href, true);
      xhr.send();
    }
  }, 30000); // A cada 30 segundos
}

// Função para detectar e contornar throttling
function preventThrottling() {
  var lastTime = performance.now();
  var frameCount = 0;
  
  function checkThrottling() {
    var currentTime = performance.now();
    var deltaTime = currentTime - lastTime;
    lastTime = currentTime;
    frameCount++;
    
    // Se o delta time for muito alto, pode indicar throttling
    if (deltaTime > 100 && !isPageVisible) {
      // Tentar reativar o contexto de áudio
      if (audioContext && audioContext.state === 'suspended') {
        audioContext.resume();
      }
      
      // Verificar se o áudio ainda está tocando
      if (!audioPlayer.paused && audioPlayer.currentTime > 0) {
        audioPlayer.play().catch(function(e) {
          console.log('Erro ao contornar throttling:', e);
        });
      }
    }
    
    requestAnimationFrame(checkThrottling);
  }
  
  requestAnimationFrame(checkThrottling);
}

// Detectar dispositivos com recursos limitados
function detectLowResourceDevice() {
  var isOldTV = (
    navigator.userAgent.includes('TV') || 
    navigator.userAgent.includes('SmartTV') ||
    navigator.userAgent.includes('CrKey')
  );
  
  var isLowMemory = (
    navigator.deviceMemory !== undefined && 
    navigator.deviceMemory < 2
  );
  
  return isOldTV || isLowMemory;
}

// Função para buscar um arquivo de texto e retornar um array de linhas
function fetchCollection(url) {
  return new Promise(function(resolve) {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', url, true);
    xhr.onreadystatechange = function() {
      if (xhr.readyState === 4) {
        if (xhr.status === 200) {
          var text = xhr.responseText;
          var lines = text.split('\n').map(function(line) {
            return line.trim();
          }).filter(function(line) {
            return line.length > 0;
          });
          resolve(lines);
        } else {
          console.error('Erro ao buscar ' + url + ': ' + xhr.statusText);
          resolve([]);
        }
      }
    };
    xhr.onerror = function() {
      console.error('Falha na requisição para ' + url);
      resolve([]);
    };
    xhr.send();
  });
}

// Função para buscar metadados de um álbum
function fetchAlbumMetadata(id) {
  return new Promise(function(resolve) {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', 'https://archive.org/metadata/' + id, true);
    xhr.onreadystatechange = function() {
      if (xhr.readyState === 4) {
        if (xhr.status === 200) {
          try {
            var data = JSON.parse(xhr.responseText);
            resolve(data);
          } catch (e) {
            console.error('Erro ao analisar JSON para ' + id + ':', e);
            resolve(null);
          }
        } else {
          console.error('Erro ao buscar metadados de ' + id + ': ' + xhr.statusText);
          resolve(null);
        }
      }
    };
    xhr.onerror = function() {
      console.error('Falha na requisição para ' + id);
      resolve(null);
    };
    
    // Timeout para evitar que requisições travem o dispositivo
    setTimeout(function() {
      if (xhr.readyState !== 4) {
        xhr.abort();
        console.error('Timeout ao buscar metadados de ' + id);
        resolve(null);
      }
    }, 15000);
    
    xhr.send();
  });
}

// Função principal que inicia todo o processo
function initializePlayer() {
  updateStatus('Inicializando player...');
  resultsContainer.innerHTML = 'Carregando listas de coleções...';
  isSimpleMode = detectLowResourceDevice();
  
  // Inicializar recursos para background playback
  initializeAudioContext();
  setupPageVisibilityAPI();
  enableBackgroundPlayback();
  preventThrottling();
  keepAliveInBackground();
  
  if (isSimpleMode) {
    document.body.classList.add('simple-mode');
    resultsContainer.innerHTML = 'Modo simplificado ativado para melhor desempenho...';
    updateStatus('Modo simplificado');
  }
  
  var minhasColecoesUrl = 'https://raw.githubusercontent.com/cavernadorock69/cavernadorock69.github.io/main/minhas_colecoes.txt';
  var outrasColecoesUrl = 'https://raw.githubusercontent.com/cavernadorock69/cavernadorock69.github.io/main/outras_colecoes.txt';

  // Carregar sequencialmente para evitar sobrecarga
  fetchCollection(minhasColecoesUrl).then(function(minhaColecaoResult) {
    minhaColecao = minhaColecaoResult;
    return fetchCollection(outrasColecoesUrl);
  }).then(function(outrosUsuariosResult) {
    outrosUsuarios = outrosUsuariosResult;
    
    if (minhaColecao.length === 0 && outrosUsuarios.length === 0) {
      resultsContainer.innerHTML = 'Nenhuma coleção encontrada. Verifique os arquivos no GitHub.';
      updateStatus('Nenhuma coleção encontrada');
      return;
    }
    
    updateStatus('Carregando álbuns...');
    carregarAlbuns();
  }).catch(function(error) {
    console.error('Erro ao carregar coleções:', error);
    resultsContainer.innerHTML = 'Erro ao carregar as coleções. Tentando novamente...';
    updateStatus('Erro ao carregar coleções');
    setTimeout(initializePlayer, 3000);
  });
}

function formatTime(seconds) {
  if (isNaN(seconds)) return "00:00";
  var mins = Math.floor(seconds / 60);
  var secs = Math.floor(seconds % 60);
  return (mins < 10 ? "0" : "") + mins + ":" + (secs < 10 ? "0" : "") + secs;
}

function updateProgress() {
  if (!isSeeking && audioPlayer.duration) {
    var percentage = (audioPlayer.currentTime / audioPlayer.duration) * 100;
    progressBar.value = percentage;
    timeDisplay.textContent = formatTime(audioPlayer.currentTime) + ' / ' + formatTime(audioPlayer.duration);
  }
}

function carregarAlbuns(){
  resultsContainer.innerHTML = 'Carregando metadados dos álbuns...';
  allTracks = [];
  albumsData = {};
  
  var albumLinks = minhaColecao.concat(outrosUsuarios);
  if(albumLinks.length === 0){
    resultsContainer.innerHTML = 'Nenhum álbum para carregar.';
    updateStatus('Nenhum álbum para carregar');
    return;
  }

  // Limitar o número de álbuns carregados em dispositivos limitados
  if (isSimpleMode && albumLinks.length > 10) {
    albumLinks = albumLinks.slice(0, 10);
    resultsContainer.innerHTML = 'Carregando primeiros 10 álbuns (modo simplificado)...';
  }

  var loadedCount = 0;
  var totalCount = albumLinks.length;
  
  // Carregar álbuns sequencialmente para evitar sobrecarga
  function loadNextAlbum(index) {
    if (index >= albumLinks.length) {
      // Todos os álbuns foram carregados
      updateStatus('Criando filtros...');
      criarFiltros();
      renderAll();
      updateStatus('Player pronto');
      return;
    }
    
    var link = albumLinks[index];
    var id = link.split('/').pop();
    
    resultsContainer.innerHTML = 'Carregando álbum ' + (index + 1) + ' de ' + totalCount + '...';
    updateStatus('Carregando álbum ' + (index + 1) + '/' + totalCount);
    
    fetchAlbumMetadata(id).then(function(data) {
      if (!data) {
        loadNextAlbum(index + 1);
        return;
      }
      
      var artist = (data.metadata && data.metadata.creator) ? data.metadata.creator : 'Desconhecido';
      var albumTitle = (data.metadata && data.metadata.title) ? data.metadata.title : id;
      var year = 9999;
      
      if(data.metadata){
        if(data.metadata.date) year = parseInt(data.metadata.date) || 9999;
        else if(data.metadata.year) year = parseInt(data.metadata.year) || 9999;
      }

      var trackList = [];
      var coverUrl = null;

      if (data.files) {
        for (var i = 0; i < data.files.length; i++) {
          var f = data.files[i];
          var ext = f.name.split('.').pop().toLowerCase();
          
          if(IMAGE_EXT.indexOf(ext) !== -1 && /cover|folder|front/i.test(f.name)){
            coverUrl = 'https://archive.org/download/' + id + '/' + encodeURIComponent(f.name);
          }
          
          if(ALLOWED_EXT.indexOf(ext) !== -1){
            var track = {
              title: f.name,
              url: 'https://archive.org/download/' + id + '/' + encodeURIComponent(f.name),
              type: (ext === 'mp4' ? 'video' : 'audio'),
              artist: artist,
              album: albumTitle,
              format: ext
            };
            trackList.push(track);
            allTracks.push(track);
          }
        }
      }

      if(!albumsData[artist]) albumsData[artist] = [];
      albumsData[artist].push({title: albumTitle, year: year, cover: coverUrl, tracks: trackList});
      
      loadedCount++;
      
      // Continuar com o próximo álbum após um pequeno delay
      setTimeout(function() {
        loadNextAlbum(index + 1);
      }, 100);
    });
  }
  
  // Iniciar o carregamento sequencial
  loadNextAlbum(0);
}

function criarFiltros(){
  var formats = {};
  for (var i = 0; i < allTracks.length; i++) {
    formats[allTracks[i].format] = true;
  }
  
  formatFilters.innerHTML = '';
  for(var fmt in formats){
    if (formats.hasOwnProperty(fmt)) {
      (function(fmt){
        var btn = document.createElement('button');
        btn.textContent = fmt.toUpperCase();
        btn.className = 'format-button' + (fmt === currentFormat ? ' active' : '');
        btn.onclick = function(){
          currentFormat = fmt;
          var buttons = formatFilters.getElementsByTagName('button');
          for (var i = 0; i < buttons.length; i++) {
            buttons[i].className = 'format-button';
          }
          this.className = 'format-button active';
          renderAll();
        };
        formatFilters.appendChild(btn);
      })(fmt);
    }
  }
}

function renderAll(){
  resultsContainer.innerHTML = '';
  tracks = [];
  
  var renderSection = function(linksArray, title) {
    if(linksArray.length > 0) {
      var headerDiv = document.createElement('div');
      headerDiv.className = 'artist-title';
      headerDiv.textContent = title;
      resultsContainer.appendChild(headerDiv);
      albumLinksRender(linksArray);
    }
  };

  renderSection(minhaColecao, 'Minha Coleção');
  renderSection(outrosUsuarios, 'Outros Usuários');
  
  if (tracks.length === 0) {
    resultsContainer.innerHTML = '<div class="error">Nenhuma música encontrada no formato ' + currentFormat.toUpperCase() + '</div>';
  }
  
  applySearchFilter();
}

function albumLinksRender(linksArray){
  var artistsInScope = [];
  
  for (var artist in albumsData) {
    if (albumsData.hasOwnProperty(artist)) {
      var artistAlbums = albumsData[artist];
      var hasAlbumInScope = false;
      
      for (var j = 0; j < artistAlbums.length; j++) {
        var album = artistAlbums[j];
        
        for (var k = 0; k < linksArray.length; k++) {
          var link = linksArray[k];
          var albumId = link.split('/').pop();
          
          for (var l = 0; l < album.tracks.length; l++) {
            if (album.tracks[l].url.indexOf(albumId) !== -1) {
              hasAlbumInScope = true;
              break;
            }
          }
          if (hasAlbumInScope) break;
        }
        if (hasAlbumInScope) break;
      }
      
      if (hasAlbumInScope) {
        artistsInScope.push(artist);
      }
    }
  }

  artistsInScope.sort(function(a, b) {
    return a.localeCompare(b);
  });

  for (var i = 0; i < artistsInScope.length; i++) {
    var artist = artistsInScope[i];
    var artistAlbums = albumsData[artist];
    
    // Filtrar álbuns que estão no escopo atual
    var albumsInScope = [];
    for (var j = 0; j < artistAlbums.length; j++) {
      var album = artistAlbums[j];
      var isInScope = false;
      
      for (var k = 0; k < linksArray.length; k++) {
        var link = linksArray[k];
        var albumId = link.split('/').pop();
        
        for (var l = 0; l < album.tracks.length; l++) {
          if (album.tracks[l].url.indexOf(albumId) !== -1) {
            isInScope = true;
            break;
          }
        }
        if (isInScope) break;
      }
      
      if (isInScope) {
        albumsInScope.push(album);
      }
    }

    albumsInScope.sort(function(a, b) {
      if (a.year !== b.year) return a.year - b.year;
      return a.title.localeCompare(b.title);
    });

    for (var j = 0; j < albumsInScope.length; j++) {
      var album = albumsInScope[j];
      var albumContainer = document.createElement('div');
      albumContainer.className = 'album-container';
      albumContainer.dataset.artist = artist.toLowerCase();
      albumContainer.dataset.album = album.title.toLowerCase();
      
      if (!isSimpleMode) {
        var albDiv = document.createElement('div');
        albDiv.className = 'album-title';
        albDiv.innerHTML = album.title + (album.year !== 9999 ? ' (' + album.year + ')' : '') + 
                          ' <span class="album-artist-name">- ' + artist + '</span>';
        albumContainer.appendChild(albDiv);
      }

      var hasTracksInFormat = false;
      
      for (var k = 0; k < album.tracks.length; k++) {
        var track = album.tracks[k];
        if(track.format !== currentFormat) continue;
        
        track.index = tracks.length;
        track.albumCover = album.cover;
        
        var trackDiv = document.createElement('div');
        trackDiv.className = 'track-item';
        trackDiv.textContent = isSimpleMode ? (track.title.length > 40 ? track.title.substring(0, 40) + '...' : track.title) : track.title;
        trackDiv.dataset.title = track.title.toLowerCase();
        trackDiv.onclick = (function(idx) {
          return function() { 
            shuffle = false; 
            playTrack(idx); 
          };
        })(track.index);
        
        track.element = trackDiv;
        tracks.push(track);
        albumContainer.appendChild(trackDiv);
        hasTracksInFormat = true;
      }
      
      if (hasTracksInFormat) {
        resultsContainer.appendChild(albumContainer);
      }
    }
  }
}

function applySearchFilter() {
  var term = searchInput.value.toLowerCase();
  var allAlbumContainers = resultsContainer.getElementsByClassName('album-container');

  for (var i = 0; i < allAlbumContainers.length; i++) {
    var container = allAlbumContainers[i];
    var artistMatch = container.dataset.artist.indexOf(term) !== -1;
    var albumMatch = container.dataset.album.indexOf(term) !== -1;
    
    if (term === '' || artistMatch || albumMatch) {
      var tracksInContainer = container.getElementsByClassName('track-item');
      for (var j = 0; j < tracksInContainer.length; j++) {
        tracksInContainer[j].style.display = 'block';
      }
      container.style.display = 'block';
      continue;
    }

    var hasVisibleTrack = false;
    var tracksInContainer = container.getElementsByClassName('track-item');
    for (var j = 0; j < tracksInContainer.length; j++) {
      var trackEl = tracksInContainer[j];
      var titleMatch = trackEl.dataset.title.indexOf(term) !== -1;
      if (titleMatch) {
        trackEl.style.display = 'block';
        hasVisibleTrack = true;
      } else {
        trackEl.style.display = 'none';
      }
    }
    
    container.style.display = hasVisibleTrack ? 'block' : 'none';
  }
}

function playTrack(index){
  var track = tracks[index]; 
  if(!track) return;
  
  // Solicitar Wake Lock quando começar a reproduzir
  requestWakeLock();
  
  currentTrack = index;
  for (var i = 0; i < tracks.length; i++) {
    if(tracks[i].element) tracks[i].element.classList.remove('playing');
  }
  
  track.element.classList.add('playing');
  trackInfo.textContent = track.artist + ' - ' + track.title;
  playPauseBtn.textContent = '⏸';
  audioPlayer.pause(); 
  audioPlayer.src = '';
  audioPlayer.src = track.url;
  
  progressBar.value = 0;
  timeDisplay.textContent = "00:00 / 00:00";
  
  if(track.albumCover){
    coverArt.src = track.albumCover;
    coverArt.style.display = 'block';
    document.querySelector('.album-background').style.backgroundImage = 'url("' + track.albumCover + '")';
  } else { 
    coverArt.style.display = 'none'; 
  }
  
  updateStatus('Reproduzindo: ' + track.title);
  
  var playPromise = audioPlayer.play();
  if (playPromise !== undefined) {
    playPromise.then(function() {
      // Reprodução iniciada com sucesso
      if (audioContext && audioContext.state === 'suspended') {
        audioContext.resume();
      }
    }).catch(function(e){
      console.error("Erro ao reproduzir áudio:", e);
      trackInfo.textContent = "Erro ao reproduzir: " + track.title;
      updateStatus('Erro na reprodução');
    });
  }
}

function playRandomTrack(){ 
  if(tracks.length === 0) return; 
  var r = Math.floor(Math.random() * tracks.length); 
  playTrack(r); 
}

function stopTrack(){ 
  audioPlayer.pause(); 
  audioPlayer.currentTime = 0; 
  playPauseBtn.textContent = '▶'; 
  progressBar.value = 0; 
  timeDisplay.textContent = "00:00 / 00:00";
  updateStatus('Parado');
  
  // Liberar Wake Lock quando parar
  releaseWakeLock();
}

function togglePlayPause(){ 
  if (audioPlayer.paused) {
    if (audioPlayer.src) {
      audioPlayer.play().then(function() {
        playPauseBtn.textContent = '⏸';
        updateStatus('Reproduzindo');
        requestWakeLock();
      }).catch(function(e) {
        console.error('Erro ao reproduzir:', e);
        updateStatus('Erro na reprodução');
      });
    } else if (tracks.length > 0) {
      playRandomTrack();
    }
  } else {
    audioPlayer.pause();
    playPauseBtn.textContent = '▶';
    updateStatus('Pausado');
    releaseWakeLock();
  }
}

function toggleShuffle(){ 
  shuffle = !shuffle; 
  shuffleBtn.classList.toggle('toggled', shuffle);
  updateStatus(shuffle ? 'Shuffle ativo' : 'Shuffle desativo');
}

function toggleRepeat(){ 
  repeat = !repeat; 
  repeatBtn.classList.toggle('toggled', repeat);
  updateStatus(repeat ? 'Repeat ativo' : 'Repeat desativo');
}

// Event listeners
volumeControl.addEventListener('input', function(){
  audioPlayer.volume = volumeControl.value;
});

audioPlayer.addEventListener('loadedmetadata', function() {
  timeDisplay.textContent = '00:00 / ' + formatTime(audioPlayer.duration);
});

audioPlayer.addEventListener('timeupdate', updateProgress);

audioPlayer.addEventListener('ended', function(){ 
  if(repeat){
    playTrack(currentTrack);
  } else { 
    if (shuffle) {
      playRandomTrack();
    } else {
      playTrack((currentTrack + 1) % tracks.length);
    }
  } 
});

audioPlayer.addEventListener('play', function() {
  updateStatus('Reproduzindo');
  requestWakeLock();
});

audioPlayer.addEventListener('pause', function() {
  updateStatus('Pausado');
  releaseWakeLock();
});

progressBar.addEventListener('input', function() {
  isSeeking = true;
});

progressBar.addEventListener('change', function() {
  if (audioPlayer.duration) {
    audioPlayer.currentTime = (progressBar.value / 100) * audioPlayer.duration;
  }
  isSeeking = false;
});

searchInput.addEventListener('input', applySearchFilter);

startIcon.addEventListener('click', function(){ 
  startIcon.style.display = 'none'; 
  if (tracks.length > 0) playRandomTrack(); 
});

prevBtn.addEventListener('click', function(){ 
  if(tracks.length > 0) { 
    currentTrack = (currentTrack - 1 + tracks.length) % tracks.length; 
    playTrack(currentTrack); 
  }
});

nextBtn.addEventListener('click', function(){ 
  if(tracks.length > 0) { 
    currentTrack = (currentTrack + 1) % tracks.length; 
    playTrack(currentTrack); 
  }
});

playPauseBtn.addEventListener('click', togglePlayPause);
stopBtn.addEventListener('click', stopTrack);
shuffleBtn.addEventListener('click', toggleShuffle);
repeatBtn.addEventListener('click', toggleRepeat);

// Inicializar quando a página carregar
document.addEventListener('DOMContentLoaded', function() {
  // Aguardar interação do usuário para inicializar o contexto de áudio
  document.addEventListener('click', function initAudioOnFirstClick() {
    if (!audioContext) {
      initializeAudioContext();
    }
    document.removeEventListener('click', initAudioOnFirstClick);
  }, { once: true });
});

// Inicia todo o processo de carregamento
initializePlayer();
</script>
</body>
</html>

