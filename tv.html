<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Caveira do Rock 69 - CLIPES</title>
  <style>
    html,body {margin:0;height:100%;font-family:Arial,Helvetica,sans-serif;background:#000;color:#fff}
    .app{max-width:1200px;margin:0 auto;padding:12px}
    .header{display:flex;align-items:center;gap:12px;margin-bottom:10px}
    .logo{width:60px;height:60px;border-radius:6px;background:#111;
      display:flex;align-items:center;justify-content:center;font-weight:bold}
    .title{font-size:20px}
    .status{margin-top:4px;font-size:14px;color:#ccc}
    .layout{display:flex;gap:12px;}
    .left{flex:1;max-width:60%;}
    .right{flex:1;max-width:40%;background:#0f0f0f;border-radius:6px;padding:8px;overflow-y:auto;max-height:80vh}
    @media (max-width:768px){.layout{flex-direction:column}.left,.right{max-width:100%}.right{max-height:none}}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
    button{background:#222;border:1px solid #333;color:#fff;
      padding:8px 12px;border-radius:6px;cursor:pointer;font-size:14px}
    button:disabled{background:#111;color:#666;cursor:not-allowed}
    .toggle{padding:6px;border-radius:20px;font-size:13px}
    .playerTop{background:#111;padding:10px;border-radius:6px}
    .playerTop video{width:100%;max-height:70vh;background:#000}
    .track{cursor:pointer;padding:6px;font-size:15px;
      border-bottom:1px solid #222;display:flex;align-items:center;gap:8px}
    .track img{width:60px;height:40px;object-fit:cover;border-radius:4px}
    .track.playing{color:#9fe88f;background:#1a1a1a}
    .loading{text-align:center;padding:20px;color:#ccc}
    .error{color:#ff6b6b;background:#2a0f0f;padding:8px;border-radius:4px;margin:5px 0}
  </style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="logo">VÍDEO</div>
    <div>
      <div class="title">CAVEIRA DO ROCK 69 - CLIPES</div>
      <div class="status" id="status">Carregando...</div>
    </div>
  </div>

  <div class="layout">
    <!-- PLAYER -->
    <div class="left">
      <div class="controls">
        <button id="prev" disabled>⏮️ Anterior</button>
        <button id="play" disabled>▶️ Play</button>
        <button id="next" disabled>⏭️ Próxima</button>
        <label class="toggle"><input type="checkbox" id="shuffle"> Aleatório</label>
        <label class="toggle"><input type="checkbox" id="repeat"> Repetir</label>
        <button id="reload">⤻ Recarregar</button>
      </div>
      <div class="playerTop">
        <div><strong>Tocando:</strong> <span id="now">—</span></div>
        <video id="video" preload="metadata" controls playsinline>
          <source id="videoSource" src="" type="video/mp4">
          Seu navegador não suporta vídeo HTML5.
        </video>
      </div>
    </div>
    <!-- LISTA -->
    <div class="right" id="library">
      <div class="loading">Carregando lista de vídeos...</div>
    </div>
  </div>
</div>

<script>
(function(){
  var video = document.getElementById('video');
  var videoSource = document.getElementById('videoSource');
  var libraryEl = document.getElementById('library');
  var statusEl = document.getElementById('status');
  var nowEl = document.getElementById('now');
  var playBtn = document.getElementById('play');
  var nextBtn = document.getElementById('next');
  var prevBtn = document.getElementById('prev');
  var shuffleCb = document.getElementById('shuffle');
  var repeatCb = document.getElementById('repeat');
  var reloadBtn = document.getElementById('reload');

  var tracks = []; 
  var current = 0; 
  var playing = false;
  var isLoading = false;
  var reconnectTimer = null;

  var owner = 'cavernadorock69';
  var repo = 'cavernadorock69.github.io';
  var branch = 'main';
  var directories = ['clips_e_shows'];

  function logStatus(t) { statusEl.textContent = t; console.log('Status:', t); }

  function enableControls() {
    playBtn.disabled = tracks.length === 0;
    nextBtn.disabled = tracks.length === 0;
    prevBtn.disabled = tracks.length === 0;
  }

  function buildLibrary(list){
    if (list.length === 0) {
      libraryEl.innerHTML = '<div class="error">Nenhum vídeo encontrado.</div>';
      return;
    }
    libraryEl.innerHTML = '';
    list.forEach(function(t){
      var div = document.createElement('div');
      div.className = 'track';
      div.dataset.idx = t.index;
      if(t.img){
        var thumb = document.createElement('img');
        thumb.src = t.img;
        div.appendChild(thumb);
      }
      var span = document.createElement('span');
      span.textContent = t.title;
      div.appendChild(span);
      div.onclick = function(){ playIndex(parseInt(this.dataset.idx, 10)); };
      libraryEl.appendChild(div);
    });
    refreshPlayingClass();
  }

  function refreshPlayingClass(){
    var elems = libraryEl.getElementsByClassName('track');
    for(var i = 0; i < elems.length; i++) elems[i].className = 'track';
    var cur = libraryEl.querySelector('.track[data-idx="' + current + '"]');
    if(cur) cur.className = 'track playing';
  }

  function setNowText(){ nowEl.textContent = tracks[current] ? tracks[current].title : '—'; }

  function playIndex(i){
    if(i < 0 || i >= tracks.length) return;
    if (reconnectTimer) { clearTimeout(reconnectTimer); reconnectTimer = null; }

    current = i; 
    var t = tracks[current];
    setNowText(); refreshPlayingClass();

    video.pause();
    videoSource.src = t.src;
    videoSource.type = "video/mp4";
    video.load();

    logStatus('Carregando: ' + t.title);

    video.onerror = function(e) {
      logStatus('Erro ao carregar, tentando novamente...');
      console.error('Erro de vídeo:', e);
      if (reconnectTimer) clearTimeout(reconnectTimer);
      reconnectTimer = setTimeout(function(){
        playIndex(current);
      }, 3000);
    };

    video.onended = function(){ logStatus('Vídeo finalizado'); nextTrack(); };

    var playPromise = video.play();
    if (playPromise) {
      playPromise.then(function(){
        playing = true; playBtn.textContent = '⏸️ Pausar'; logStatus('Reproduzindo: ' + t.title);
      }).catch(function(err){
        playing = false; playBtn.textContent = '▶️ Play'; logStatus('Clique em Play para iniciar');
        console.log('Autoplay bloqueado:', err);
      });
    }
    enableControls();
  }

  playBtn.onclick = function(){
    if(!video.src && tracks.length>0){ playIndex(0); return; }
    if(video.paused){
      var p = video.play();
      if(p) p.then(()=>{playing=true; playBtn.textContent='⏸️ Pausar'; logStatus('Reproduzindo');})
             .catch(err=>{logStatus('Erro: '+err.message);});
    } else {
      video.pause(); playing=false; playBtn.textContent='▶️ Play'; logStatus('Pausado');
    }
  };
  nextBtn.onclick = function(){ nextTrack(); };
  prevBtn.onclick = function(){ prevTrack(); };

  function nextTrack(){
    if(shuffleCb.checked){ 
      var newIndex; 
      do{ newIndex = Math.floor(Math.random()*tracks.length);}while(newIndex===current && tracks.length>1);
      playIndex(newIndex); return;
    }
    var nx=current+1;
    if(nx>=tracks.length){ if(repeatCb.checked) nx=0; else{ video.pause(); playing=false; playBtn.textContent='▶️ Play'; logStatus('Fim da lista'); return;} }
    playIndex(nx);
  }
  function prevTrack(){
    if(shuffleCb.checked){ 
      var newIndex; 
      do{ newIndex = Math.floor(Math.random()*tracks.length);}while(newIndex===current && tracks.length>1);
      playIndex(newIndex); return;
    }
    var pr=current-1; if(pr<0) pr=repeatCb.checked?tracks.length-1:0; playIndex(pr);
  }

  video.addEventListener('loadedmetadata', function(){
    logStatus('Metadados carregados');
    console.log('Duração:', video.duration);
    console.log('Audio Tracks:', video.audioTracks ? video.audioTracks.length : 'não suportado');
    console.log('Video Tracks:', video.videoTracks ? video.videoTracks.length : 'não suportado');
  });

  // --------- Carrega playlists do GitHub ----------
  function fetchM3UFilesInDir(dir, cb){
    var url = 'https://api.github.com/repos/' + owner + '/' + repo + '/contents/' + encodeURIComponent(dir) + '?ref=' + branch;
    var xhr = new XMLHttpRequest(); xhr.open('GET', url, true); xhr.timeout = 15000;
    xhr.onload = function(){
      if(xhr.status===200){ try{ var list=JSON.parse(xhr.responseText); var m3us=[];
        list.forEach(function(it){ if(it.type==='file'&&it.name.toLowerCase().endsWith('.m3u')){
          m3us.push('https://raw.githubusercontent.com/'+owner+'/'+repo+'/'+branch+'/'+dir+'/'+it.name);}});
        cb(null,m3us);}catch(e){cb(e,null);} }
      else cb(new Error('GitHub status '+xhr.status),null);
    };
    xhr.onerror=function(){cb(new Error('Erro de rede em '+dir),null);};
    xhr.ontimeout=function(){cb(new Error('Timeout em '+dir),null);};
    xhr.send();
  }

  function loadAll(){
    if (isLoading) return; isLoading=true; tracks=[]; current=0; playing=false;
    logStatus('Buscando playlists...'); libraryEl.innerHTML='<div class="loading">Buscando playlists...</div>';
    var pending=directories.length; var urls=[]; var errors=[];
    directories.forEach(function(dir){
      fetchM3UFilesInDir(dir,function(err,u){
        if(err){errors.push(err.message);}
        if(u&&u.length>0) urls=urls.concat(u);
        pending--; if(pending===0){
          if(urls.length===0){ logStatus('Nenhuma playlist encontrada'); libraryEl.innerHTML='<div class="error">Nenhuma playlist</div>'; isLoading=false;}
          else{ logStatus('Carregando '+urls.length+' playlist(s)...'); loadPlaylistsFromUrls(urls);}
        }
      });
    });
  }

  function loadPlaylistsFromUrls(urls){
    var pending=urls.length; var loaded=0; var errors=[];
    urls.forEach(function(u,index){
      setTimeout(function(){
        var xhr=new XMLHttpRequest(); xhr.open('GET',u,true); xhr.timeout=20000;
        xhr.onload=function(){ if(xhr.status===200&&xhr.responseText){ try{ appendFound(parseM3UContent(xhr.responseText,u)); }catch(e){errors.push('Erro '+u);} }
          else errors.push('Falha '+u);
          loaded++; if(loaded>=pending){ buildLibrary(tracks); setNowText(); logStatus('Carregado '+tracks.length+' vídeo(s).'); enableControls(); isLoading=false; }};
        xhr.onerror=function(){errors.push('Erro rede '+u); loaded++; if(loaded>=pending){buildLibrary(tracks);setNowText();}};
        xhr.ontimeout=function(){errors.push('Timeout '+u); loaded++; if(loaded>=pending){buildLibrary(tracks);setNowText();}};
        xhr.send();
      }, index*1000);
    });
  }

  function parseM3UContent(txt, base){
    var lines=txt.split(/\r?\n/); var found=[]; var title=null; var img=null;
    lines.forEach(function(l){
      l=l.trim(); if(!l) return;
      if(l.startsWith('#EXTINF')){ var parts=l.split(','); title=parts[1]?parts[1].trim():null; }
      else if(l.startsWith('#EXTIMG')){ img=l.replace('#EXTIMG:','').trim(); }
      else if(!l.startsWith('#')){
        var src=l;
        if(!/^https?:\/\//i.test(l)&&base.includes('raw.githubusercontent')){
          var parts=base.split('/'); parts.pop(); src=parts.join('/')+'/'+l;
        }
        if(/\.(mp4|m4v|mov|avi|mkv|webm|ogv)$/i.test(src)){
          found.push({src:src,title:title||src.split('/').pop(),img:img});
        }
        title=null; img=null;
      }
    }); return found;
  }

  function appendFound(arr){
    arr.forEach(function(obj){
      if(!tracks.some(tr=>tr.src===obj.src)){
        var idx=tracks.length;
        tracks.push({src:obj.src,title:obj.title||'Sem título',img:obj.img||null,index:idx});
      }
    });
  }

  reloadBtn.onclick = loadAll;
  document.addEventListener('DOMContentLoaded', function(){ loadAll(); });
})();
</script>
</body>
</html>
